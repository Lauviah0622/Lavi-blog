<!DOCTYPE html><html domain="lavi-blog.vercel.app" lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="default-src 'self';object-src 'none';script-src 'self' 'sha256-Ky9qZOPnMhQV/s7Fdb9TYAOfU4KtWNqCZaFK8tSzXa0=' 'sha256-za/u+GpTRqxVmtY0/RJrU1alkYqdlDRMaW2bCpySaa8=' 'sha256-Fc9RvR5cQc4eds/61y5EGXrmOqQOE0YF/KJfE7B/NJs=' 'sha256-AvHvdkAvA2liH7FoblyZGebwmSzE3eLp/zZiYQ+l2Qk=' https://utteranc.es/client.js;style-src 'unsafe-inline' 'self' https://fonts.googleapis.com/ https://fonts.gstatic.com/;img-src 'self' data:;frame-src https://utteranc.es/;font-src https://fonts.gstatic.com/ 'self'" http-equiv="Content-Security-Policy"><link href="/img/favicon/favicon-192x192.png?hash=46a52117ad" rel="icon" type="image/png"><meta content="#f9c412" name="theme-color"><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name="robots"><title>React 的 batch update 策略，包含 React 18 和 hooks</title><meta content="React 的 batch update 策略，包含 React 18 和 hooks" property="og:title"><meta content="在面試時有一題讓自己印象深刻： export default function App() { const [counter, setCounter] = useState(0); const handleClick = () => { setCounter(counter +..." name="description"><meta content="在面試時有一題讓自己印象深刻： export default function App() { const [counter, setCounter] = useState(0); const handleClick = () => { setCounter(counter +..." property="og:description"><meta content="summary_large_image" name="twitter:card"><meta content="@" name="twitter:site"><meta content="@" name="twitter:creator"><link href="https://lavi-blog.vercel.app/posts/react-batch-update/" rel="canonical"><meta content="no-referrer-when-downgrade" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Apprentice Log"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=c909e7f885" defer=""></script><script csp-hash="sha256-Ky9qZOPnMhQV/s7Fdb9TYAOfU4KtWNqCZaFK8tSzXa0=">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>@import url(https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap);
/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}button,html{line-height:1.15}html{-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:100%;font-size:var(--font-base-size);width:100vw;letter-spacing:.04ch}body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji';--color-primary:var(--light-primary);--color-secondary:var(--light-secondary);--color-text:var(--light-text);--color-text-reverse:var(--dark-text);--color-text-secondary:var(--light-text-secondary);--color-bg:hsl(var(--light-bg));--color-bg-reverse:var(--dark-bg);--color-bg-opacity:hsla(var(--light-bg), 0.9);--color-bg-secondary:var(--light-bg-grey);--font-weight-normal:400;background-color:var(--color-bg);color:var(--color-text);overflow-x:hidden}hr{height:0;color:inherit;margin:3rem auto;width:95%}code,pre{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace}button{font-family:inherit;font-size:100%;margin:0;text-transform:none}[type=button],button{-webkit-appearance:button}:root{--primary-hue:200;--primary-saturation:20%;--primary-light:60%;--secondary-hue:22;--secondary-saturation:85%;--secondary-light:60%;--text-hue:200;--text-saturation:10%;--text-light:10%;--light-primary:hsl(
      var(--primary-hue),
      var(--primary-saturation),
      var(--primary-light)
    );--light-secondary:hsl(
      var(--secondary-hue),
      var(--secondary-saturation),
      60%
    );--light-text:hsl(var(--text-hue), var(--text-saturation), var(--text-light));--light-text-secondary:hsl(var(--primary-hue), var(--text-saturation), 45%);--light-bg:0, 0%, 98%;--light-bg-grey:hsl(var(--primary-hue), var(--primary-saturation), 90%);--dark-bg:hsl(var(--primary-hue), 15%, 5%);--dark-bg-reverse:hsl(var(--primary-hue), 20%, 20%);--dark-bg-opacity:hsla(var(--primary-hue), var(--primary-saturation), 5%, 95%);--dark-bg-grey:hsl(var(--primary-hue), var(--primary-saturation), 15%);--dark-text:hsl(var(--text-hue), 30%, 90%);--dark-text-secondary:hsl(var(--primary-hue), 35%, 70%);--font-base-size:18px;--breakpoint-s-m:576.98px;--breakpoint-m-l:992.98px;--font-family-serif:Lora, Georgia, Songti TC, Hiragino Mincho Pro, serif;--font-family-sans-serif:"Inter", Roboto, Segoe UI, Ubuntu, Helvetica Neue,
      Helvetica, Arial, "Noto Sans TC", sans-serif;--font-family-mono:"DM mono", monospace, "Kosugi Maru", "Noto Sans TC",
      sans-serif;--font-weight-bold:600;--block-border-radius:1ch}body.dark-theme{--color-primary:var(--light-primary);--color-secondary:var(--light-secondary);--color-text:var(--dark-text);--color-text-reverse:var(--dark-text);--color-text-secondary:var(--dark-text-secondary);--color-bg:var(--dark-bg);--color-bg-reverse:var(--dark-bg-reverse);--color-bg-opacity:var(--dark-bg-opacity);--color-bg-secondary:var(--dark-bg-grey);--font-weight-normal:300}@font-face{font-display:optional;font-family:"Inter UI";font-style:normal;font-weight:400;src:url(/fonts/Inter-Regular.woff2) format("woff2"),url(/fonts/Inter-Regular.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:italic;font-weight:400;src:url(/fonts/Inter-Italic.woff2) format("woff2"),url(/fonts/Inter-Italic.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:normal;font-weight:600;src:url(/fonts/Inter-SemiBold.woff2) format("woff2"),url(/fonts/Inter-SemiBold.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:italic;font-weight:600;src:url(/fonts/Inter-SemiBoldItalic.woff2) format("woff2"),url(/fonts/Inter-SemiBoldItalic.woff) format("woff")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-style:normal;src:url(/fonts/Lora-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-style:italic;src:url(/fonts/Lora-Italic.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-weight:600;font-style:italic;src:url(/fonts/Lora-SemiBold.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-weight:600;font-style:italic;src:url(/fonts/Lora-SemiBoldItalic.ttf) format("truetype")}@font-face{font-display:optional;font-family:"DM mono";font-display:swap;font-style:normal;src:url(/fonts/DMMono-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"DM mono";font-display:swap;font-style:italic;src:url(/fonts/DMMono-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Inter UI var";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"Inter UI var alt";font-weight:100 900;font-style:normal;font-named-instance:"Regular";src:url(/fonts/Inter-roman.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"Inter UI var alt";font-weight:100 900;font-style:italic;font-named-instance:"Italic";src:url(/fonts/Inter-italic.var.woff2) format("woff2")}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1}*{transition:background-color .1s,color .1s}h1,h2,h3,h4,p{text-decoration:none;font-weight:var(--font-weight-normal);margin:0}.dark-theme h1,.dark-theme h2,.dark-theme h3,.dark-theme h4{font-weight:400}h1,h2,h3,h4{line-height:1.2}blockquote,li{font-weight:var(--font-weight-normal)}h1{font-size:2rem;padding:3rem 0 1.6rem}h2{font-size:1.6rem;padding:2rem 0 .8rem}h3{font-size:1.4rem;padding:1.6rem 0 .8rem}h4{font-size:1.2rem;padding:1.2rem 0 .8rem}.icon,.icon path{fill:var(--color-primary)}a{text-decoration:none}a:hover{text-decoration:underline}main{margin:50px 0 100px}.caption,.caption a,a{color:var(--color-text-secondary)}.caption,.caption a{font-size:.6rem}.caption a,.post__toc li:hover>a{text-decoration:underline}.tags a::before{content:"#"}.tags{text-transform:capitalize}s{-webkit-text-decoration-color:var(--color-text-secondary);text-decoration-color:var(--color-text-secondary)}blockquote{position:relative;padding:2rem;padding-right:0;margin:1.2rem 0;font-family:var(--font-family-serif)}blockquote::before{top:0;left:0;content:"";position:absolute;display:block;height:100%;width:5px;background-color:var(--color-primary);border-radius:2px}article,blockquote>ol,blockquote>ul{padding:0}code{font-size:.9em;font-family:var(--font-family-mono)}:not(pre)>code{display:inline-block;padding:.2ch;background-color:var(--color-bg-reverse);color:var(--color-text-reverse);border-radius:.4ch;margin:0 .4ch;line-height:1.1rem}dialog,pre{background-color:var(--color-bg-reverse)}pre{color:var(--color-text-reverse);margin:1.2rem -2rem;padding:1.2rem 2rem;border-radius:var(--block-border-radius);font-size:.9em;line-height:inherit;overflow-x:auto}dialog{position:fixed;bottom:0;z-index:9999;color:var(--color-secondary);width:100vw;border-width:0;text-align:center;height:-webkit-min-content;height:-moz-min-content;height:min-content}body:not(.dark-theme) #light{display:none}body.dark-theme #dark{display:none}body.dark-theme #light{display:block}body.dark-theme img{filter:brightness(.8) contrast(1.2)}@media (prefers-color-scheme:dark){#light{display:block}img{filter:brightness(.8) contrast(1.2)}}@media (prefers-color-scheme:light){#dark{display:block}}.center{--max-width:63ch;width:100%;display:grid;grid-template-columns:1fr min(var(--max-width),calc(100% - 64px)) 1fr}.center>*{grid-column:2}.center--wide{--max-width:1040px}body .container{display:grid;min-height:100vh;grid-template-rows:auto -webkit-max-content;grid-template-rows:auto max-content}header{top:0;position:sticky;display:flex;align-items:flex-end;margin-top:50px;padding:8px 0 15px;background-color:var(--color-bg);z-index:1}header p{margin-top:0}header>div{width:100%;display:flex;align-items:baseline;justify-content:space-between}#hamburger,.only-mobile{display:none}#hamburger{position:fixed;pointer-events:auto;--hamburger-size:2rem;height:var(--hamburger-size);width:var(--hamburger-size);margin:1.5rem;right:0;z-index:999}#hamburger>*{display:block;width:80%;height:calc(var(--hamburger-size)*.08);background-color:var(--color-primary);position:absolute;top:50%;left:50%;transition:all 400ms cubic-bezier(.84,.06,.52,1.8);transform-origin:center}#hamburger top{transform:translate(-50%,calc(var(--hamburger-size)*.25))}#hamburger mid{transform:translate(-50%,0)}#hamburger btm{transform:translate(-50%,calc(var(--hamburger-size)*-.25))}#hamburger.open top{transform:translate(-50%,0) rotate(45deg)}#hamburger.open mid{opacity:0}#hamburger.open btm{transform:translate(-50%,0) rotate(-45deg)}.header__items,nav{display:flex;align-items:center}.header__items>*{margin:0 .6rem}.header__items svg{height:1rem;width:1rem}.header__theme{height:1rem;overflow:visible}#rss{height:1.2rem;width:1.2rem}nav{align-items:baseline;gap:1.5rem}nav>a{font-size:1rem;font-weight:400;color:var(--color-text-secondary)}.logo{margin:0;padding:0;font-size:1.4rem;text-align:left}.logo a{margin:0;color:var(--color-text);text-decoration:none}.logo svg{height:1.5em;position:relative;top:.3em;margin-right:10px}footer{background-color:var(--color-bg-secondary);padding:2rem 0;height:-webkit-min-content;height:-moz-min-content;height:min-content}.footer{display:flex;justify-content:space-between}.footer__info{text-align:right;display:flex;flex-direction:column;gap:1rem}footer nav{visibility:hidden}@media only screen and (max-device-width:576.98px){.only-mobile{display:inherit}#hamburger{display:block}header{position:fixed;margin-top:0;padding-top:6rem;--transition:all 500ms cubic-bezier(0.075, 0.82, 0.165, 1);transition:var(--transition);pointer-events:auto;opacity:1;background-color:var(--color-bg-opacity);height:100%}header .logo{display:none}header:not(.open){transition:var(--transition);background-color:transparent;pointer-events:none;opacity:0}header>div,nav{flex-direction:column;gap:2rem}header>div{align-items:flex-end;padding-right:2rem;align-self:start}nav{align-items:end}.nav>*{margin:0;font-size:1.2em}.header__items svg{height:1.2em;width:1.2em}.logo--mobile{padding:1.5rem 0;z-index:99}.footer{flex-direction:column}footer nav{visibility:visible}footer nav>.logo,nav{margin-bottom:1rem}}.post__time{font-family:var(--font-family-serif);margin:9px 0 4px}.post__time p,.post__title{padding:0}.post__toc{position:fixed;top:50%;padding-left:2rem;transform:translateY(-50%);font-size:.8em;max-height:70vh;overflow-y:scroll;-ms-overflow-style:none;scrollbar-width:none;scroll-behavior:smooth}.post__toc::-webkit-scrollbar{display:none}.post__toc ol{list-style-type:none;padding:0 0 0 1ch;width:20ch}.post__toc ol ol{width:100%}.post__toc li{width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:.2em 0}.post__toc li a{text-decoration:none}.post__toc .current,.post__toc .current>a{color:var(--color-secondary)}.post__content{padding-top:3rem}.post__content h1,.post__content h2,.post__content h3,.post__content h4,.post__content h5,.post__content h6{position:relative}.post__content h1 a[href^="#"],.post__content h2 a[href^="#"],.post__content h3 a[href^="#"],.post__content h4 a[href^="#"],.post__content h5 a[href^="#"],.post__content h6 a[href^="#"]{position:absolute;left:-1.4ch}.post__content h1 a:not([href^="#"]),.post__content h2 a:not([href^="#"]),.post__content h3 a:not([href^="#"]),.post__content h4 a:not([href^="#"]),.post__content h5 a:not([href^="#"]),.post__content h6 a:not([href^="#"]){color:inherit;text-decoration:inherit}.post__content li,.post__content p{line-height:1.6}.post__content p{padding:.8rem 0}.post__content li{padding:.2rem 0}.post__content ol,.post__content ul{padding:1.2rem 1rem 1.2rem 1.8rem;font-family:var(--font-family-serif);margin:0}.post__content ol li::marker,.post__content ul li::marker{color:var(--color-text-secondary)}.post__content p~ol,.post__content p~ul{padding-top:0}.post__content ol li::marker{font-size:1.1em}.post__content ol ol,.post__content ol ul,.post__content ul ol,.post__content ul ul{padding:0 1.2rem}.post__content hr{margin-top:4rem;margin-bottom:4rem}.post__content img{max-height:50vh;width:auto;margin:0 auto}.token.comment,.token.doctype{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.tag{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.attr-value,.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}.post__link{display:flex;justify-content:space-between;margin-top:2rem}.post__link>div>*{display:block}.post__link>div>span{font-size:.8em;margin-bottom:.2em}.post__link>div:last-of-type span{text-align:right}@media only screen and (max-device-width:576.98px){.post__content img{max-height:30vh}.post__content blockquote{padding:1rem 1.5rem;margin:.6rem 0}.post__content pre{margin-right:0;margin-left:0;padding:1.5rem 2ch;width:calc(100vw - 6ch)}.post__toc{background-color:var(--color-bg-secondary);position:static;transform:none;padding:3ch;border-radius:var(--block-border-radius)}.post__toc h4{padding-top:0}.post__toc nav{align-items:flex-start;font-size:1rem;margin:0}.post__toc ol{padding-left:2rem;width:auto}.post__toc li a{display:inline-block;padding-bottom:.3em}.post__toc li{white-space:normal}.post__toc nav>ol{padding-left:0;margin:0}.post__toc .current,.post__toc a:active,.post__toc a:hover{color:inherit}}.tag li{display:flex;align-items:flex-start}.tag h2{text-transform:capitalize}</style></head><body><script csp-hash="sha256-za/u+GpTRqxVmtY0/RJrU1alkYqdlDRMaW2bCpySaa8=">let isUtterancesLoaded = false;
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = localStorage.getItem("theme");
      const isDark = currentTheme != null ?　currentTheme === 'dark' : prefersDarkScheme.matches;
      if (isDark) {
          document.body.classList.add('dark-theme');
          setUtterancesTheme('dark');
      } else {  
        document.body.classList.remove('dark-theme');
          setUtterancesTheme('light');
      }
      
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }
        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === 'dark' ? 'dark-blue' : 'github-light'
        }, 'https://utteranc.es');
      }</script><dialog id="message"></dialog><header class="center center--wide"><div><nav class="nav"><h1 class="logo"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1><a href="/posts/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></nav><div class="header__items"><div class="header__theme"><svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" id="dark" height="16" width="16"><path d="M6.85141 0.219686C7.03763 0.405907 7.11254 0.676155 7.04875 0.931669C6.92055 1.44524 6.85229 1.98329 6.85229 2.53834C6.85229 6.1886 9.81142 9.14773 13.4617 9.14773C14.0167 9.14773 14.5548 9.07948 15.0683 8.95127C15.3239 8.88749 15.5941 8.96239 15.7803 9.14861C15.9665 9.33483 16.0415 9.60508 15.9777 9.8606C15.0974 13.3869 11.9095 16 8.10939 16C3.6307 16 -1.78814e-07 12.3693 0 7.89062C1.78814e-07 4.09054 2.61311 0.902648 6.13943 0.0223469C6.39495 -0.041439 6.66519 0.0334652 6.85141 0.219686ZM5.37954 1.8693C3.09107 2.90847 1.5 5.21444 1.5 7.89062C1.5 11.5409 4.45913 14.5 8.10939 14.5C10.7856 14.5 13.0915 12.9089 14.1307 10.6205C13.91 10.6385 13.6869 10.6477 13.4617 10.6477C8.98299 10.6477 5.35229 7.01703 5.35229 2.53834C5.35229 2.31317 5.36149 2.09003 5.37954 1.8693Z" fill="black" clip-rule="evenodd" fill-rule="evenodd"></path></svg> <svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" id="light" height="16" width="16"><path d="M8.00006 1.17009e-09C8.41427 2.28894e-05 8.75004 0.335828 8.75001 0.750041L8.74999 1.25004C8.74996 1.66426 8.41416 2.00002 7.99994 2C7.58573 1.99998 7.24996 1.66417 7.24999 1.24996L7.25001 0.749959C7.25004 0.335745 7.58584 -2.2887e-05 8.00006 1.17009e-09ZM2.34319 2.34311C2.6361 2.05023 3.11097 2.05026 3.40385 2.34316L3.75738 2.69674C4.05026 2.98965 4.05023 3.46452 3.75732 3.7574C3.46441 4.05027 2.98954 4.05025 2.69666 3.75734L2.34313 3.40377C2.05025 3.11086 2.05028 2.63598 2.34319 2.34311ZM13.6569 2.34319C13.9498 2.6361 13.9497 3.11097 13.6568 3.40385L13.3033 3.75738C13.0104 4.05026 12.5355 4.05023 12.2426 3.75732C11.9497 3.46441 11.9498 2.98954 12.2427 2.69666L12.5962 2.34313C12.8891 2.05025 13.364 2.05028 13.6569 2.34319ZM8.00026 5.5C6.61955 5.5 5.50026 6.61929 5.50026 8C5.50026 9.38071 6.61955 10.5 8.00026 10.5C9.38097 10.5 10.5003 9.38071 10.5003 8C10.5003 6.61929 9.38097 5.5 8.00026 5.5ZM4.00026 8C4.00026 5.79086 5.79112 4 8.00026 4C10.2094 4 12.0003 5.79086 12.0003 8C12.0003 10.2091 10.2094 12 8.00026 12C5.79112 12 4.00026 10.2091 4.00026 8ZM1.17006e-09 7.99994C2.28894e-05 7.58573 0.335828 7.24996 0.750041 7.24999L1.25004 7.25001C1.66426 7.25004 2.00002 7.58584 2 8.00006C1.99998 8.41427 1.66417 8.75004 1.24996 8.75001L0.749959 8.74999C0.335745 8.74996 -2.2887e-05 8.41416 1.17006e-09 7.99994ZM14 7.99994C14 7.58573 14.3358 7.24996 14.75 7.24999L15.25 7.25001C15.6643 7.25004 16 7.58584 16 8.00006C16 8.41427 15.6642 8.75004 15.25 8.75001L14.75 8.74999C14.3357 8.74996 14 8.41416 14 7.99994ZM12.2427 12.2426C12.5356 11.9497 13.0105 11.9498 13.3033 12.2427L13.6569 12.5962C13.9498 12.8891 13.9497 13.364 13.6568 13.6569C13.3639 13.9498 12.889 13.9497 12.5962 13.6568L12.2426 13.3033C11.9497 13.0104 11.9498 12.5355 12.2427 12.2426ZM3.7574 12.2427C4.05027 12.5356 4.05025 13.0105 3.75734 13.3033L3.40377 13.6569C3.11086 13.9498 2.63598 13.9497 2.34311 13.6568C2.05023 13.3639 2.05025 12.889 2.34316 12.5962L2.69674 12.2426C2.98965 11.9497 3.46452 11.9498 3.7574 12.2427ZM8.00006 14C8.41427 14 8.75004 14.3358 8.75001 14.75L8.74999 15.25C8.74996 15.6643 8.41416 16 7.99994 16C7.58573 16 7.24996 15.6642 7.24999 15.25L7.25001 14.75C7.25004 14.3357 7.58584 14 8.00006 14Z" fill="black" clip-rule="evenodd" fill-rule="evenodd"></path></svg></div><a href="/feed/feed.xml"><svg fill="none" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="icon" id="rss"><path d="M3.75 3C3.33579 3 3 3.33579 3 3.75C3 4.16421 3.33579 4.5 3.75 4.5H4.82759C10.7216 4.5 15.5 9.27925 15.5 15.1751V16.25C15.5 16.6642 15.8358 17 16.25 17C16.6642 17 17 16.6642 17 16.25V15.1751C17 8.45116 11.5504 3 4.82759 3H3.75Z"></path><path d="M3 7.19904C3 6.78482 3.33579 6.44904 3.75 6.44904H4.82759C9.64596 6.44904 13.5517 10.356 13.5517 15.1751V16.2499C13.5517 16.6642 13.2159 16.9999 12.8017 16.9999C12.3875 16.9999 12.0517 16.6642 12.0517 16.2499V15.1751C12.0517 11.1841 8.8172 7.94904 4.82759 7.94904H3.75C3.33579 7.94904 3 7.61325 3 7.19904Z"></path><path d="M3.75 9.89813C3.33579 9.89813 3 10.2339 3 10.6481C3 11.0623 3.33579 11.3981 3.75 11.3981H4.82759C6.91277 11.3981 8.60345 13.089 8.60345 15.1751V16.2499C8.60345 16.6642 8.93923 16.9999 9.35345 16.9999C9.76766 16.9999 10.1034 16.6642 10.1034 16.2499V15.1751C10.1034 12.2609 7.74153 9.89813 4.82759 9.89813H3.75Z"></path><path d="M5 13C3.89543 13 3 13.8954 3 15C3 16.1046 3.89543 17 5 17C6.10457 17 7 16.1046 7 15C7 13.8954 6.10457 13 5 13ZM4.5 15C4.5 14.7239 4.72386 14.5 5 14.5C5.27614 14.5 5.5 14.7239 5.5 15C5.5 15.2761 5.27614 15.5 5 15.5C4.72386 15.5 4.5 15.2761 4.5 15Z" clip-rule="evenodd" fill-rule="evenodd"></path></svg></a></div></div></header><div id="hamburger"><top></top><mid></mid><btm></btm></div><div class="container"><div class="center only-mobile"><h1 class="logo logo--mobile"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1></div><main class="center"><div class="post__tags tags"><a href="/tags/react/">react</a></div><h1 class="post__title" id="title">React 的 batch update 策略，包含 React 18 和 hooks</h1><div class="post__time"><p><time datetime="2021-06-09">Jun,9 2021・7min read.</time></p></div><aside class="post__toc"><h4 class="only-mobile">TOC</h4><nav class="toc"><ol><li data-header="%E4%BB%80%E9%BA%BC%E6%98%AF-batch-update"><a href="#%E4%BB%80%E9%BA%BC%E6%98%AF-batch-update">什麼是 Batch Update</a></li><li data-header="%E7%9B%AE%E5%89%8D%E5%A6%82%E4%BD%95%E8%A9%B2%E4%BD%BF%E7%94%A8-batch-update"><a href="#%E7%9B%AE%E5%89%8D%E5%A6%82%E4%BD%95%E8%A9%B2%E4%BD%BF%E7%94%A8-batch-update">目前如何該使用 Batch Update</a><ol><li data-header="react-%E4%B8%AD%E7%9A%84-batch-update"><a href="#react-%E4%B8%AD%E7%9A%84-batch-update">React 中的 Batch update</a><ol><li data-header="event-handler"><a href="#event-handler">event Handler</a></li><li data-header="useeffect"><a href="#useeffect">useEffect</a></li><li data-header="%E9%9D%9E%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C%E5%92%8C-reactdom.unstable_batchedupdates()"><a href="#%E9%9D%9E%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C%E5%92%8C-reactdom.unstable_batchedupdates()">非同步操作和 ReactDOM.unstable_batchedUpdates()</a></li></ol></li><li data-header="redux-%E7%9A%84-batch"><a href="#redux-%E7%9A%84-batch">Redux 的 Batch</a></li></ol></li><li data-header="react-18-%E7%9A%84-batching"><a href="#react-18-%E7%9A%84-batching">React 18 的 Batching</a></li><li data-header="%E7%B5%90%E8%AA%9E"><a href="#%E7%B5%90%E8%AA%9E">結語</a></li><li data-header="%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><a href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99">參考資料</a></li></ol></nav></aside><article class="post__content"><p>在面試時有一題讓自己印象深刻：</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>counter<span class="token punctuation">,</span> setCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <br>  <span class="token keyword">const</span> <span class="token function function-variable">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>      <span class="token function">setCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">setCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>App<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Function Component</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>        counter: </span><span class="token punctuation">{</span>counter<span class="token punctuation">}</span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Click me</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><a href="https://codesandbox.io/s/wild-platform-w801i?file=/src/App.js:39-424">CodeSandbox 連結</a></p><p>第一個問題是：上面的 code，即使點擊一次 button，<code>counter</code> 也只會 + 1，原因是什麼？</p><p>我的回答是：</p><blockquote><p>因為 <code>setCounter(counter + 1);</code> 這段已經改變 state 了，所以當下 Component 就會被 rerender，那後面第二次的 <code>setCounter</code> 就不會被執行。</p></blockquote><p>後面緊接著第二個問題：如果上面的 Code 要改成 +2，你會怎麼做？</p><p>自己是有回答的出來（有做到 +2 的需求），不過主管表示說解題的方向不對，這題主要是在考 batch update 的觀念。</p><p>後來查了一下，回頭發現連第一題都回答錯了（慘爆）。了解之後就想寫篇文章分享這個觀念。</p><h2 id="%E4%BB%80%E9%BA%BC%E6%98%AF-batch-update"><a href="#%E4%BB%80%E9%BA%BC%E6%98%AF-batch-update" class="direct-link">#</a> 什麼是 Batch Update</h2><p>在 React 裡面，不管是 state 或者是 props 的改變都會造成 Component 的 re-render，這點在使用 hook 或者是 class component 中都一樣。</p><p>那如果當一個操作中多次改變了 state，是不是就會造成 component 多次 rerender 呢？那對應的就會造成資源耗損，所以這時候就會將所有的改變 state 的操作一次蒐集起來，再統一改變 state，這樣就只需要 re-render 一次就好了，這個就是 Batch update。</p><p>那 React 的 Batch Update 是怎麼做的？我們可以看看 React 作者之一 Dan 的 <a href="https://overreacted.io/react-as-a-ui-runtime/#batching">文章</a>中的範例，這邊擷取文章中的一部分範例以及原文。但個人還是推薦去閱讀 Dan 的真跡，每一篇文章都受益良多。</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onClick</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      Parent clicked </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text"> times<br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      Child clicked </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text"> times<br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>當你在點擊 <code>Child</code> 中的 button 時，因為 <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Building_blocks/Events#event_bubbling_and_capture">event bubbling</a> 的關係，所以也會連帶觸發到 <code>Parent</code> 中 <code>div</code> 的 <code>onclick</code> 事件。如果在沒有 batch update 的狀況下，會是這樣 re-render 的</p><pre><code>*** Entering React's browser click event handler ***
Child (onClick)
  - setState
  - re-render Child // 😞 不需要的 re-render
Parent (onClick)
  - setState
  - re-render Parent
  - re-render Child
*** Exiting React's browser click event handler ***
</code></pre><p>Child 因為自己的 setState 而 re-render 一次，但又因為 Parent 的 state 改變而 re-render 第二次。</p><p>但是在 React 中，對於 event handler 中的 update 有進行 batch update 的處理，所以實際上的方式會是這樣：</p><pre><code>*** Entering React's browser click event handler ***
Child (onClick)
  - setState
Parent (onClick)
  - setState
*** Processing state updates                     ***
  - re-render Parent
  - re-render Child
*** Exiting React's browser click event handler  ***
</code></pre><p>這樣就減少了一次 re-render 了！真棒！</p><p>理解了 React 中 batch update 的觀念後就可以來看面試題了，這裡再放一次 code</p><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>counter<span class="token punctuation">,</span> setCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <br>  <span class="token keyword">const</span> <span class="token function function-variable">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>      <span class="token function">setCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">setCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>App<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Function Component</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>        counter: </span><span class="token punctuation">{</span>counter<span class="token punctuation">}</span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Click me</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><blockquote><p>第一題： 上面的 code，即使點擊一次 button，<code>counter</code> 也只會 + 1，原因是什麼？</p></blockquote><p>原因根本不是如自己說的，因為第一次的 setCounter 就已經觸發 re-render，所以第二次的 setCounter 就被忽略。雖然和 Dan 的例子不太一樣，但是在同一個 Component 中的 event handler 也是會進行 batch update 的。</p><p>等等，那不就應該 +2 才對嗎？怎麼會是 +1？</p><p>原因出在這段：</p><pre class="language-js"><code class="language-js"><span class="token function">setCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">setCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>當這段 code 被送出去時，state 的指向的是目前的這個狀態的 state（詳細可以看<a href="https://overreacted.io/zh-hant/a-complete-guide-to-useeffect/">這篇</a> Dan 的文章，雖然很長），換句話說，這段可以看成這樣：</p><pre class="language-js"><code class="language-js"><span class="token function">setCounter</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">setCounter</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>所以等於設定了兩次 <code>setCounter(0 + 1)</code>。檢查方法很簡單，在 eventHandler 後面 <code>print</code> 出一點東西就知道有沒有執行到最後了。</p><p>那第二個問題：</p><blockquote><p>如果上面的 Code 要改成 +2，你會怎麼做？</p></blockquote><p>只要改成這樣就可以了</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function function-variable">increase</span> <span class="token operator">=</span> <span class="token parameter">prevCounter</span> <span class="token operator">=&gt;</span> prevCounter <span class="token operator">+</span> <span class="token number">1</span><br><span class="token keyword">const</span> <span class="token function function-variable">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>      <span class="token function">setCounter</span><span class="token punctuation">(</span>increase<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">setCounter</span><span class="token punctuation">(</span>increase<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span></code></pre><p>利用 setState 的 <a href="https://reactjs.org/docs/hooks-reference.html#functional-updates">functional update</a>，那就會變成「前次值 + 1」，而不是指定數字。就能夠達到 +2 的需求了。</p><h2 id="%E7%9B%AE%E5%89%8D%E5%A6%82%E4%BD%95%E8%A9%B2%E4%BD%BF%E7%94%A8-batch-update"><a href="#%E7%9B%AE%E5%89%8D%E5%A6%82%E4%BD%95%E8%A9%B2%E4%BD%BF%E7%94%A8-batch-update" class="direct-link">#</a> 目前如何該使用 Batch Update</h2><p>了解什麼是 batch update 後，可以開始了解說哪裡會進行這樣的處理。</p><h3 id="react-%E4%B8%AD%E7%9A%84-batch-update"><a href="#react-%E4%B8%AD%E7%9A%84-batch-update" class="direct-link">#</a> React 中的 Batch update</h3><h4 id="event-handler"><a href="#event-handler" class="direct-link">#</a> event Handler</h4><p>Handler Batch 範例：<a href="https://codesandbox.io/s/romantic-sanne-e9hgs-e9hgs?file=/src/HandlerBatchSample.jsx">https://codesandbox.io/s/romantic-sanne-e9hgs-e9hgs?file=/src/HandlerBatchSample.jsx</a></p><p>可以看到不管是點擊 <code>add many local state</code>，還是點擊 <code>increace all State in Another Component</code>，render 次數都只會新增 1。只要是單次的 event 中的所有的 state change 都會被 batch 起來，即使在不同的 component、不同的元素也都會做 batching。面試題也屬於這個狀況。</p><h4 id="useeffect"><a href="#useeffect" class="direct-link">#</a> useEffect</h4><p>Effect Batch 範例：<a href="https://codesandbox.io/s/affectionate-carson-2jovc?file=/src/EffectBatchSample.jsx">https://codesandbox.io/s/affectionate-carson-2jovc?file=/src/EffectBatchSample.jsx</a></p><p>同樣的 useEffect 中也會。範例中改變 toggle 後，useEffect 被觸發，進而其中多個 <code>setCounter</code>，但是卻沒有被 rerender 四次。證明說有進行 batch。</p><p>那為什麼每次點擊之後 counter 都會 +2 呢？原因是因為，couter 的 useEffect 並沒有設置 dependency，所以會在每次 render 的時候被觸發，所以：</p><ol><li>第一次為 toggle 改變的時候被觸發</li><li>第二次為 couter 改變的時候被觸發</li></ol><blockquote><p>話說這裡有個問題，還有除了這兩種操作 State 以外的情境嗎...？</p></blockquote><h4 id="%E9%9D%9E%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C%E5%92%8C-reactdom.unstable_batchedupdates()"><a href="#%E9%9D%9E%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C%E5%92%8C-reactdom.unstable_batchedupdates()" class="direct-link">#</a> 非同步操作和 <code>ReactDOM.unstable_batchedUpdates()</code></h4><p>再回頭看 Event Handler 的範例中，如果點擊 <code>async increase all state</code>，就會依照我們原本預期的重新 render 4 次（在其中操作 state 4 次）。React 在非同步的操作中並不會自動執行 batch State。</p><p>但可以使用 <code>ReactDOM.unstable_batchedUpdates(callback)</code>，將操作包在 callback 裡面，那一樣會進行 batching。</p><h3 id="redux-%E7%9A%84-batch"><a href="#redux-%E7%9A%84-batch" class="direct-link">#</a> Redux 的 Batch</h3><p>在 Redux 裡面也有 <a href="https://react-redux.js.org/api/batch">batching</a>，可以使用 <code>batch</code> 這個 API 一次 dispatch 多個 action，避免多次的 rerender。</p><h2 id="react-18-%E7%9A%84-batching"><a href="#react-18-%E7%9A%84-batching" class="direct-link">#</a> React 18 的 Batching</h2><p>Dan 在 <a href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/issues/10231">Keep to single setState call？</a> 這份 issue 裡面有提到：</p><blockquote><p>There exists a temporary API to force batching. If you write ReactDOM.unstable_batchedUpdates(() =&gt; { this.fn1(); }); then both calls will be batched. But we expect to remove this API in the future and instead batch everything by default.</p></blockquote><p>是的！就是現在！<a href="https://github.com/reactwg/react-18">react 18 </a>alpha 版釋出啦，其中就有實現上面提到的方式。可以參考其中一篇 <a href="https://github.com/reactwg/react-18/discussions/21">discusstions：Automatic batching for fewer renders in React 18</a>，那這邊也稍做介紹</p><p>在新的 React 18，所有的狀況都會預設進行 batching（原本在非同步的狀況不會進行）。而如果有需要即時更新 state 來讓 DOM 渲染的話，則可以使用新的 API <code>ReactDOM.flushSync()</code>，使用方法如下，範例<a href="https://github.com/reactwg/react-18/discussions/21">來自</a></p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> flushSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span> <span class="token comment">// Note: react-dom, not react</span><br><br><span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token function">setCounter</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// React has updated the DOM by now</span><br>  <span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// React has updated the DOM by now</span><br><span class="token punctuation">}</span></code></pre><p>用法算是反過來，你想要剝離的操作，用 flushSync 包起來，而想要 batching 的操作就維持原狀。自己稍微測試的結果，<code>ReactDOM.flushSync()</code> 裡面的 state change 會先於 batching，不論在執行時的順序。不過這樣一來，原本的 <code>ReactDOM.unstable_batchedUpdates()</code> 就可以說是被棄用了。</p><h2 id="%E7%B5%90%E8%AA%9E"><a href="#%E7%B5%90%E8%AA%9E" class="direct-link">#</a> 結語</h2><p>整個研究的過程蠻久的，從面試題完到現在寫完文章，有趣的是剛好搭上 React 18 更新也稍微研究一下 XD。</p><p>Big guy is John，如果有任何問題或錯誤的部份歡迎留言或者是寄信，會超級感謝！！</p><h2 id="%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><a href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99" class="direct-link">#</a> 參考資料</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/78516581">深入 react 细节之 - batchUpdate</a>有稍微提到 source code</li><li><a href="https://medium.com/swlh/react-state-batch-update-b1b61bd28cd2">React State Batch Update</a>，少數提到 useEffect 也有做 batching</li></ul><p>範例大部分參考自上面兩篇文章</p><ul><li><a href="https://overreacted.io/react-as-a-ui-runtime/#batching">React as a UI Runtime</a></li><li><a href="https://github.com/reactwg/react-18/discussions/21">Automatic batching for fewer renders in React 18 #21</a></li><li><a href="https://github.com/Rashomon511/MyBlog/issues/27">react 的 BatchUpdate</a> 沒看完，太多 source code 有點吸收不下</li></ul></article><div class="post__tags tags"><h2>tags</h2><a href="/tags/react/">react</a></div><div class="post__link"><div><span>Prev</span><a href="/posts/about-writing/" class="">關於寫文章的問題</a></div><div><span>Next</span><a href="/posts/redirect-status-code/" class="">[極短篇] 關於重新導向的 status code</a></div></div><hr class="post__devider"><div class="utterances"></div><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" issue-term="title" label="utterance" repo="Lauviah0622/Lavi-blog" theme="github-light"></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "React 的 batch update 策略，包含 React 18 和 hooks",
  "image": [],
  "author": "Lavi", 
  "genre": "Insert a schema.org genre", 
  "publisher": {
    "@type": "Organization",
    "name": "Lavi",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/favicon/favicon-192x192.png?hash=46a52117ad"
    }
  },
  "url": "https://lavi-blog.vercel.app/posts/react-batch-update/",
  "mainEntityOfPage": "https://lavi-blog.vercel.app/posts/react-batch-update/",
  "datePublished": "2021-06-09",
  "dateModified": "2021-10-22",
  "description": "在面試時有一題讓自己印象深刻： export default function App() { const [counter, setCounter] = useState(0); const handleClick = () =&gt; { setCounter(counter +..."
}</script><script csp-hash="sha256-Fc9RvR5cQc4eds/61y5EGXrmOqQOE0YF/KJfE7B/NJs=">let prevElement;
 const io = new IntersectionObserver(
  (entries) => {
    entries.forEach((entry) => {
      const id = entry.target.id
        if (id === "title") {
          const title = document.querySelector(`#${id}`)
          if (prevElement) {
            prevElement.classList.remove('current');
          }
          return  
        }
        const current = document.querySelector(`[data-header="${id}"]`);
        if (current == null) return 
        if (entry.isIntersecting) {
          current.classList.add('current');
          

          let scrollTo = current.offsetTop - 100;
          current.offsetParent.scrollTo(0, scrollTo < 0 ? 0 : scrollTo);
          if (prevElement && prevElement != current) {
            prevElement.classList.remove('current');
          }
          prevElement = current
        }
        
    });
  },
  {
    rootMargin: "-10% 0% -70% 0%",
  }
);

// Declares what to observe, and observes its properties.
const boxElList = document.querySelectorAll('h1, h2, h3, h4');
boxElList.forEach((el) => {
    io.observe(el);
})</script></main><footer class="center center--wide"><div class="footer"><div><nav class="nav"><h1 class="logo"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1><a href="/posts/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></nav></div><div class="caption footer__info"><div><a href="https://github.com/Lauviah0622" target="_blank"><svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M12.026 2C7.13295 1.99937 2.96183 5.54799 2.17842 10.3779C1.395 15.2079 4.23061 19.893 8.87302 21.439C9.37302 21.529 9.55202 21.222 9.55202 20.958C9.55202 20.721 9.54402 20.093 9.54102 19.258C6.76602 19.858 6.18002 17.92 6.18002 17.92C5.99733 17.317 5.60459 16.7993 5.07302 16.461C4.17302 15.842 5.14202 15.856 5.14202 15.856C5.78269 15.9438 6.34657 16.3235 6.66902 16.884C6.94195 17.3803 7.40177 17.747 7.94632 17.9026C8.49087 18.0583 9.07503 17.99 9.56902 17.713C9.61544 17.207 9.84055 16.7341 10.204 16.379C7.99002 16.128 5.66202 15.272 5.66202 11.449C5.64973 10.4602 6.01691 9.5043 6.68802 8.778C6.38437 7.91731 6.42013 6.97325 6.78802 6.138C6.78802 6.138 7.62502 5.869 9.53002 7.159C11.1639 6.71101 12.8882 6.71101 14.522 7.159C16.428 5.868 17.264 6.138 17.264 6.138C17.6336 6.97286 17.6694 7.91757 17.364 8.778C18.0376 9.50423 18.4045 10.4626 18.388 11.453C18.388 15.286 16.058 16.128 13.836 16.375C14.3153 16.8651 14.5612 17.5373 14.511 18.221C14.511 19.555 14.499 20.631 14.499 20.958C14.499 21.225 14.677 21.535 15.186 21.437C19.8265 19.8884 22.6591 15.203 21.874 10.3743C21.089 5.54565 16.9181 1.99888 12.026 2Z" fill="#2E3A59"></path></svg></a></div><p>© 2020-present Lavi. All Rights Reserved.<br>This website based on <a href="https://www.industrialempathy.com/posts/eleventy-high-performance-blog/">eleventy-high-performance-blog</a>.</p></div></div></footer></div><script csp-hash="sha256-AvHvdkAvA2liH7FoblyZGebwmSzE3eLp/zZiYQ+l2Qk=">const dark = document.querySelector('#dark');
      const light = document.querySelector('#light');
      dark.addEventListener('click', () => {
        document.body.classList.add('dark-theme')
        localStorage.setItem("theme", 'dark')
        setUtterancesTheme('dark');
      })
      light.addEventListener('click', () => {
        document.body.classList.remove('dark-theme')
        localStorage.setItem("theme", 'light')
        setUtterancesTheme('light');
      })
      const ham = document.querySelector('#hamburger');
      ham.addEventListener('click', () => {
        document.querySelector('header').classList.toggle('open')
        ham.classList.toggle('open');
      })</script></body></html>