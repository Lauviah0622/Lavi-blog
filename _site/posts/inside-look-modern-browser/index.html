<!DOCTYPE html><html domain="lavi-blog.vercel.app" lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="default-src 'self';object-src 'none';script-src 'self' 'sha256-Ky9qZOPnMhQV/s7Fdb9TYAOfU4KtWNqCZaFK8tSzXa0=' 'sha256-za/u+GpTRqxVmtY0/RJrU1alkYqdlDRMaW2bCpySaa8=' 'sha256-Fc9RvR5cQc4eds/61y5EGXrmOqQOE0YF/KJfE7B/NJs=' 'sha256-AvHvdkAvA2liH7FoblyZGebwmSzE3eLp/zZiYQ+l2Qk=' https://utteranc.es/client.js;style-src 'unsafe-inline' 'self' https://fonts.googleapis.com/ https://fonts.gstatic.com/;img-src 'self' data:;frame-src https://utteranc.es/;font-src https://fonts.gstatic.com/ 'self'" http-equiv="Content-Security-Policy"><link href="/img/favicon/favicon-192x192.png?hash=46a52117ad" rel="icon" type="image/png"><meta content="#f9c412" name="theme-color"><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name="robots"><title>Inside look at modern web browser</title><meta content="Inside look at modern web browser" property="og:title"><meta content="大概看完了這個系列，想寫一下筆記，現在這個程度看這個文章資訊量還對我來說還是蠻驚人的，雖然 Huli 會說當作科普來看就好，但還是做個筆記吧 XD。不然自己一定會忘記的。 先概覽一下四個章節分別在講什麼： Part1 會講解說 CPU/GPU 各自的功用，還有講解 Process..." name="description"><meta content="大概看完了這個系列，想寫一下筆記，現在這個程度看這個文章資訊量還對我來說還是蠻驚人的，雖然 Huli 會說當作科普來看就好，但還是做個筆記吧 XD。不然自己一定會忘記的。 先概覽一下四個章節分別在講什麼： Part1 會講解說 CPU/GPU 各自的功用，還有講解 Process..." property="og:description"><meta content="summary_large_image" name="twitter:card"><meta content="@" name="twitter:site"><meta content="@" name="twitter:creator"><link href="https://lavi-blog.vercel.app/posts/inside-look-modern-browser/" rel="canonical"><meta content="no-referrer-when-downgrade" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Apprentice Log"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=c909e7f885" defer=""></script><script csp-hash="sha256-Ky9qZOPnMhQV/s7Fdb9TYAOfU4KtWNqCZaFK8tSzXa0=">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>@import url(https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap);
/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html,input{line-height:1.15}html{-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:100%;font-size:var(--font-base-size);width:100vw;letter-spacing:.04ch}body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji';--color-primary:var(--light-primary);--color-secondary:var(--light-secondary);--color-text:var(--light-text);--color-text-reverse:var(--dark-text);--color-text-secondary:var(--light-text-secondary);--color-bg:hsl(var(--light-bg));--color-bg-reverse:var(--dark-bg);--color-bg-opacity:hsla(var(--light-bg), 0.9);--color-bg-secondary:var(--light-bg-grey);--font-weight-normal:400;background-color:var(--color-bg);color:var(--color-text);overflow-x:hidden}hr{height:0;color:inherit;margin:3rem auto;width:95%}strong{font-weight:bolder;font-weight:var(--font-weight-bold);color:var(--color-secondary)}code,pre{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace}input{font-family:inherit;font-size:100%;margin:0}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}summary{display:list-item}:root{--primary-hue:200;--primary-saturation:20%;--primary-light:60%;--secondary-hue:22;--secondary-saturation:85%;--secondary-light:60%;--text-hue:200;--text-saturation:10%;--text-light:10%;--light-primary:hsl(
      var(--primary-hue),
      var(--primary-saturation),
      var(--primary-light)
    );--light-secondary:hsl(
      var(--secondary-hue),
      var(--secondary-saturation),
      60%
    );--light-text:hsl(var(--text-hue), var(--text-saturation), var(--text-light));--light-text-secondary:hsl(var(--primary-hue), var(--text-saturation), 45%);--light-bg:0, 0%, 98%;--light-bg-grey:hsl(var(--primary-hue), var(--primary-saturation), 90%);--dark-bg:hsl(var(--primary-hue), 15%, 5%);--dark-bg-reverse:hsl(var(--primary-hue), 20%, 20%);--dark-bg-opacity:hsla(var(--primary-hue), var(--primary-saturation), 5%, 95%);--dark-bg-grey:hsl(var(--primary-hue), var(--primary-saturation), 15%);--dark-text:hsl(var(--text-hue), 30%, 90%);--dark-text-secondary:hsl(var(--primary-hue), 35%, 70%);--font-base-size:18px;--breakpoint-s-m:576.98px;--breakpoint-m-l:992.98px;--font-family-serif:Lora, Georgia, Songti TC, Hiragino Mincho Pro, serif;--font-family-sans-serif:"Inter", Roboto, Segoe UI, Ubuntu, Helvetica Neue,
      Helvetica, Arial, "Noto Sans TC", sans-serif;--font-family-mono:"DM mono", monospace, "Kosugi Maru", "Noto Sans TC",
      sans-serif;--font-weight-bold:600;--block-border-radius:1ch}body.dark-theme{--color-primary:var(--light-primary);--color-secondary:var(--light-secondary);--color-text:var(--dark-text);--color-text-reverse:var(--dark-text);--color-text-secondary:var(--dark-text-secondary);--color-bg:var(--dark-bg);--color-bg-reverse:var(--dark-bg-reverse);--color-bg-opacity:var(--dark-bg-opacity);--color-bg-secondary:var(--dark-bg-grey);--font-weight-normal:300}@font-face{font-display:optional;font-family:"Inter UI";font-style:normal;font-weight:400;src:url(/fonts/Inter-Regular.woff2) format("woff2"),url(/fonts/Inter-Regular.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:italic;font-weight:400;src:url(/fonts/Inter-Italic.woff2) format("woff2"),url(/fonts/Inter-Italic.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:normal;font-weight:600;src:url(/fonts/Inter-SemiBold.woff2) format("woff2"),url(/fonts/Inter-SemiBold.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:italic;font-weight:600;src:url(/fonts/Inter-SemiBoldItalic.woff2) format("woff2"),url(/fonts/Inter-SemiBoldItalic.woff) format("woff")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-style:normal;src:url(/fonts/Lora-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-style:italic;src:url(/fonts/Lora-Italic.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-weight:600;font-style:italic;src:url(/fonts/Lora-SemiBold.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-weight:600;font-style:italic;src:url(/fonts/Lora-SemiBoldItalic.ttf) format("truetype")}@font-face{font-display:optional;font-family:"DM mono";font-display:swap;font-style:normal;src:url(/fonts/DMMono-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"DM mono";font-display:swap;font-style:italic;src:url(/fonts/DMMono-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Inter UI var";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"Inter UI var alt";font-weight:100 900;font-style:normal;font-named-instance:"Regular";src:url(/fonts/Inter-roman.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"Inter UI var alt";font-weight:100 900;font-style:italic;font-named-instance:"Italic";src:url(/fonts/Inter-italic.var.woff2) format("woff2")}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1}*{transition:background-color .1s,color .1s}h1,h2,h3,h4,p{text-decoration:none;font-weight:var(--font-weight-normal);margin:0}.dark-theme h1,.dark-theme h2,.dark-theme h3,.dark-theme h4{font-weight:400}h1,h2,h3,h4{line-height:1.2}blockquote,li{font-weight:var(--font-weight-normal)}h1{font-size:2rem;padding:3rem 0 1.6rem}h2{font-size:1.6rem;padding:2rem 0 .8rem}h3{font-size:1.4rem;padding:1.6rem 0 .8rem}h4{font-size:1.2rem;padding:1.2rem 0 .8rem}.icon,.icon path{fill:var(--color-primary)}a{text-decoration:none}a:hover{text-decoration:underline}main{margin:50px 0 100px}.caption,.caption a,a{color:var(--color-text-secondary)}.caption,.caption a{font-size:.6rem}.caption a,.post__toc li:hover>a{text-decoration:underline}.tags a::before{content:"#"}.tags{text-transform:capitalize}s{-webkit-text-decoration-color:var(--color-text-secondary);text-decoration-color:var(--color-text-secondary)}blockquote{position:relative;padding:2rem;padding-right:0;margin:1.2rem 0;font-family:var(--font-family-serif)}blockquote::before{top:0;left:0;content:"";position:absolute;display:block;height:100%;width:5px;background-color:var(--color-primary);border-radius:2px}article,blockquote>ol,blockquote>ul{padding:0}code{font-size:.9em;font-family:var(--font-family-mono)}:not(pre)>code{display:inline-block;padding:.2ch;background-color:var(--color-bg-reverse);color:var(--color-text-reverse);border-radius:.4ch;margin:0 .4ch;line-height:1.1rem}dialog,pre{background-color:var(--color-bg-reverse)}pre{color:var(--color-text-reverse);margin:1.2rem -2rem;padding:1.2rem 2rem;border-radius:var(--block-border-radius);font-size:.9em;line-height:inherit;overflow-x:auto}dialog{position:fixed;bottom:0;z-index:9999;color:var(--color-secondary);width:100vw;border-width:0;text-align:center;height:-webkit-min-content;height:-moz-min-content;height:min-content}body:not(.dark-theme) #light{display:none}body.dark-theme #dark{display:none}body.dark-theme #light{display:block}body.dark-theme img{filter:brightness(.8) contrast(1.2)}@media (prefers-color-scheme:dark){#light{display:block}img{filter:brightness(.8) contrast(1.2)}}@media (prefers-color-scheme:light){#dark{display:block}}.center{--max-width:63ch;width:100%;display:grid;grid-template-columns:1fr min(var(--max-width),calc(100% - 64px)) 1fr}.center>*{grid-column:2}.center--wide{--max-width:1040px}body .container{display:grid;min-height:100vh;grid-template-rows:auto -webkit-max-content;grid-template-rows:auto max-content}header{top:0;position:sticky;display:flex;align-items:flex-end;margin-top:50px;padding:8px 0 15px;background-color:var(--color-bg);z-index:1}header p{margin-top:0}header>div{width:100%;display:flex;align-items:baseline;justify-content:space-between}#hamburger,.only-mobile{display:none}#hamburger{position:fixed;pointer-events:auto;--hamburger-size:2rem;height:var(--hamburger-size);width:var(--hamburger-size);margin:1.5rem;right:0;z-index:999}#hamburger>*{display:block;width:80%;height:calc(var(--hamburger-size)*.08);background-color:var(--color-primary);position:absolute;top:50%;left:50%;transition:all 400ms cubic-bezier(.84,.06,.52,1.8);transform-origin:center}#hamburger top{transform:translate(-50%,calc(var(--hamburger-size)*.25))}#hamburger mid{transform:translate(-50%,0)}#hamburger btm{transform:translate(-50%,calc(var(--hamburger-size)*-.25))}#hamburger.open top{transform:translate(-50%,0) rotate(45deg)}#hamburger.open mid{opacity:0}#hamburger.open btm{transform:translate(-50%,0) rotate(-45deg)}.header__items,nav{display:flex;align-items:center}.header__items>*{margin:0 .6rem}.header__items svg{height:1rem;width:1rem}.header__theme{height:1rem;overflow:visible}#rss{height:1.2rem;width:1.2rem}nav{align-items:baseline;gap:1.5rem}nav>a{font-size:1rem;font-weight:400;color:var(--color-text-secondary)}.logo{margin:0;padding:0;font-size:1.4rem;text-align:left}.logo a{margin:0;color:var(--color-text);text-decoration:none}.logo svg{height:1.5em;position:relative;top:.3em;margin-right:10px}footer{background-color:var(--color-bg-secondary);padding:2rem 0;height:-webkit-min-content;height:-moz-min-content;height:min-content}.footer{display:flex;justify-content:space-between}.footer__info{text-align:right;display:flex;flex-direction:column;gap:1rem}footer nav{visibility:hidden}@media only screen and (max-device-width:576.98px){.only-mobile{display:inherit}#hamburger{display:block}header{position:fixed;margin-top:0;padding-top:6rem;--transition:all 500ms cubic-bezier(0.075, 0.82, 0.165, 1);transition:var(--transition);pointer-events:auto;opacity:1;background-color:var(--color-bg-opacity);height:100%}header .logo{display:none}header:not(.open){transition:var(--transition);background-color:transparent;pointer-events:none;opacity:0}header>div,nav{flex-direction:column;gap:2rem}header>div{align-items:flex-end;padding-right:2rem;align-self:start}nav{align-items:end}.nav>*{margin:0;font-size:1.2em}.header__items svg{height:1.2em;width:1.2em}.logo--mobile{padding:1.5rem 0;z-index:99}.footer{flex-direction:column}footer nav{visibility:visible}footer nav>.logo,nav{margin-bottom:1rem}}.post__time{font-family:var(--font-family-serif);margin:9px 0 4px}.post__time p,.post__title{padding:0}.post__toc{position:fixed;top:50%;padding-left:2rem;transform:translateY(-50%);font-size:.8em;max-height:70vh;overflow-y:scroll;-ms-overflow-style:none;scrollbar-width:none;scroll-behavior:smooth}.post__toc::-webkit-scrollbar{display:none}.post__toc ol{list-style-type:none;padding:0 0 0 1ch;width:20ch}.post__toc ol ol{width:100%}.post__toc li{width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:.2em 0}.post__toc li a{text-decoration:none}.post__toc .current,.post__toc .current>a{color:var(--color-secondary)}.post__content{padding-top:3rem}.post__content h1,.post__content h2,.post__content h3,.post__content h4,.post__content h5,.post__content h6{position:relative}.post__content h1 a[href^="#"],.post__content h2 a[href^="#"],.post__content h3 a[href^="#"],.post__content h4 a[href^="#"],.post__content h5 a[href^="#"],.post__content h6 a[href^="#"]{position:absolute;left:-1.4ch}.post__content h1 a:not([href^="#"]),.post__content h2 a:not([href^="#"]),.post__content h3 a:not([href^="#"]),.post__content h4 a:not([href^="#"]),.post__content h5 a:not([href^="#"]),.post__content h6 a:not([href^="#"]){color:inherit;text-decoration:inherit}.post__content li,.post__content p{line-height:1.6}.post__content p{padding:.8rem 0}.post__content li{padding:.2rem 0}.post__content ol,.post__content ul{padding:1.2rem 1rem 1.2rem 1.8rem;font-family:var(--font-family-serif);margin:0}.post__content ol li::marker,.post__content ul li::marker{color:var(--color-text-secondary)}.post__content p~ol,.post__content p~ul{padding-top:0}.post__content ol li::marker{font-size:1.1em}.post__content ol ol,.post__content ol ul,.post__content ul ol,.post__content ul ul{padding:0 1.2rem}.post__content hr{margin-top:4rem;margin-bottom:4rem}.post__content img{max-height:50vh;width:auto;margin:0 auto}.post__link{display:flex;justify-content:space-between;margin-top:2rem}.post__link>div>*{display:block}.post__link>div>span{font-size:.8em;margin-bottom:.2em}.post__link>div:last-of-type span{text-align:right}@media only screen and (max-device-width:576.98px){.post__content img{max-height:30vh}.post__content blockquote{padding:1rem 1.5rem;margin:.6rem 0}.post__content pre{margin-right:0;margin-left:0;padding:1.5rem 2ch;width:calc(100vw - 6ch)}.post__toc{background-color:var(--color-bg-secondary);position:static;transform:none;padding:3ch;border-radius:var(--block-border-radius)}.post__toc h4{padding-top:0}.post__toc nav{align-items:flex-start;font-size:1rem;margin:0}.post__toc ol{padding-left:2rem;width:auto}.post__toc li a{display:inline-block;padding-bottom:.3em}.post__toc li{white-space:normal}.post__toc nav>ol{padding-left:0;margin:0}.post__toc .current,.post__toc a:active,.post__toc a:hover{color:inherit}}.tag li{display:flex;align-items:flex-start}.tag h2{text-transform:capitalize}</style></head><body><script csp-hash="sha256-za/u+GpTRqxVmtY0/RJrU1alkYqdlDRMaW2bCpySaa8=">let isUtterancesLoaded = false;
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = localStorage.getItem("theme");
      const isDark = currentTheme != null ?　currentTheme === 'dark' : prefersDarkScheme.matches;
      if (isDark) {
          document.body.classList.add('dark-theme');
          setUtterancesTheme('dark');
      } else {  
        document.body.classList.remove('dark-theme');
          setUtterancesTheme('light');
      }
      
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }
        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === 'dark' ? 'dark-blue' : 'github-light'
        }, 'https://utteranc.es');
      }</script><dialog id="message"></dialog><header class="center center--wide"><div><nav class="nav"><h1 class="logo"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1><a href="/posts/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></nav><div class="header__items"><div class="header__theme"><svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" id="dark" height="16" width="16"><path d="M6.85141 0.219686C7.03763 0.405907 7.11254 0.676155 7.04875 0.931669C6.92055 1.44524 6.85229 1.98329 6.85229 2.53834C6.85229 6.1886 9.81142 9.14773 13.4617 9.14773C14.0167 9.14773 14.5548 9.07948 15.0683 8.95127C15.3239 8.88749 15.5941 8.96239 15.7803 9.14861C15.9665 9.33483 16.0415 9.60508 15.9777 9.8606C15.0974 13.3869 11.9095 16 8.10939 16C3.6307 16 -1.78814e-07 12.3693 0 7.89062C1.78814e-07 4.09054 2.61311 0.902648 6.13943 0.0223469C6.39495 -0.041439 6.66519 0.0334652 6.85141 0.219686ZM5.37954 1.8693C3.09107 2.90847 1.5 5.21444 1.5 7.89062C1.5 11.5409 4.45913 14.5 8.10939 14.5C10.7856 14.5 13.0915 12.9089 14.1307 10.6205C13.91 10.6385 13.6869 10.6477 13.4617 10.6477C8.98299 10.6477 5.35229 7.01703 5.35229 2.53834C5.35229 2.31317 5.36149 2.09003 5.37954 1.8693Z" fill="black" clip-rule="evenodd" fill-rule="evenodd"></path></svg> <svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" id="light" height="16" width="16"><path d="M8.00006 1.17009e-09C8.41427 2.28894e-05 8.75004 0.335828 8.75001 0.750041L8.74999 1.25004C8.74996 1.66426 8.41416 2.00002 7.99994 2C7.58573 1.99998 7.24996 1.66417 7.24999 1.24996L7.25001 0.749959C7.25004 0.335745 7.58584 -2.2887e-05 8.00006 1.17009e-09ZM2.34319 2.34311C2.6361 2.05023 3.11097 2.05026 3.40385 2.34316L3.75738 2.69674C4.05026 2.98965 4.05023 3.46452 3.75732 3.7574C3.46441 4.05027 2.98954 4.05025 2.69666 3.75734L2.34313 3.40377C2.05025 3.11086 2.05028 2.63598 2.34319 2.34311ZM13.6569 2.34319C13.9498 2.6361 13.9497 3.11097 13.6568 3.40385L13.3033 3.75738C13.0104 4.05026 12.5355 4.05023 12.2426 3.75732C11.9497 3.46441 11.9498 2.98954 12.2427 2.69666L12.5962 2.34313C12.8891 2.05025 13.364 2.05028 13.6569 2.34319ZM8.00026 5.5C6.61955 5.5 5.50026 6.61929 5.50026 8C5.50026 9.38071 6.61955 10.5 8.00026 10.5C9.38097 10.5 10.5003 9.38071 10.5003 8C10.5003 6.61929 9.38097 5.5 8.00026 5.5ZM4.00026 8C4.00026 5.79086 5.79112 4 8.00026 4C10.2094 4 12.0003 5.79086 12.0003 8C12.0003 10.2091 10.2094 12 8.00026 12C5.79112 12 4.00026 10.2091 4.00026 8ZM1.17006e-09 7.99994C2.28894e-05 7.58573 0.335828 7.24996 0.750041 7.24999L1.25004 7.25001C1.66426 7.25004 2.00002 7.58584 2 8.00006C1.99998 8.41427 1.66417 8.75004 1.24996 8.75001L0.749959 8.74999C0.335745 8.74996 -2.2887e-05 8.41416 1.17006e-09 7.99994ZM14 7.99994C14 7.58573 14.3358 7.24996 14.75 7.24999L15.25 7.25001C15.6643 7.25004 16 7.58584 16 8.00006C16 8.41427 15.6642 8.75004 15.25 8.75001L14.75 8.74999C14.3357 8.74996 14 8.41416 14 7.99994ZM12.2427 12.2426C12.5356 11.9497 13.0105 11.9498 13.3033 12.2427L13.6569 12.5962C13.9498 12.8891 13.9497 13.364 13.6568 13.6569C13.3639 13.9498 12.889 13.9497 12.5962 13.6568L12.2426 13.3033C11.9497 13.0104 11.9498 12.5355 12.2427 12.2426ZM3.7574 12.2427C4.05027 12.5356 4.05025 13.0105 3.75734 13.3033L3.40377 13.6569C3.11086 13.9498 2.63598 13.9497 2.34311 13.6568C2.05023 13.3639 2.05025 12.889 2.34316 12.5962L2.69674 12.2426C2.98965 11.9497 3.46452 11.9498 3.7574 12.2427ZM8.00006 14C8.41427 14 8.75004 14.3358 8.75001 14.75L8.74999 15.25C8.74996 15.6643 8.41416 16 7.99994 16C7.58573 16 7.24996 15.6642 7.24999 15.25L7.25001 14.75C7.25004 14.3357 7.58584 14 8.00006 14Z" fill="black" clip-rule="evenodd" fill-rule="evenodd"></path></svg></div><a href="/feed/feed.xml"><svg fill="none" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="icon" id="rss"><path d="M3.75 3C3.33579 3 3 3.33579 3 3.75C3 4.16421 3.33579 4.5 3.75 4.5H4.82759C10.7216 4.5 15.5 9.27925 15.5 15.1751V16.25C15.5 16.6642 15.8358 17 16.25 17C16.6642 17 17 16.6642 17 16.25V15.1751C17 8.45116 11.5504 3 4.82759 3H3.75Z"></path><path d="M3 7.19904C3 6.78482 3.33579 6.44904 3.75 6.44904H4.82759C9.64596 6.44904 13.5517 10.356 13.5517 15.1751V16.2499C13.5517 16.6642 13.2159 16.9999 12.8017 16.9999C12.3875 16.9999 12.0517 16.6642 12.0517 16.2499V15.1751C12.0517 11.1841 8.8172 7.94904 4.82759 7.94904H3.75C3.33579 7.94904 3 7.61325 3 7.19904Z"></path><path d="M3.75 9.89813C3.33579 9.89813 3 10.2339 3 10.6481C3 11.0623 3.33579 11.3981 3.75 11.3981H4.82759C6.91277 11.3981 8.60345 13.089 8.60345 15.1751V16.2499C8.60345 16.6642 8.93923 16.9999 9.35345 16.9999C9.76766 16.9999 10.1034 16.6642 10.1034 16.2499V15.1751C10.1034 12.2609 7.74153 9.89813 4.82759 9.89813H3.75Z"></path><path d="M5 13C3.89543 13 3 13.8954 3 15C3 16.1046 3.89543 17 5 17C6.10457 17 7 16.1046 7 15C7 13.8954 6.10457 13 5 13ZM4.5 15C4.5 14.7239 4.72386 14.5 5 14.5C5.27614 14.5 5.5 14.7239 5.5 15C5.5 15.2761 5.27614 15.5 5 15.5C4.72386 15.5 4.5 15.2761 4.5 15Z" clip-rule="evenodd" fill-rule="evenodd"></path></svg></a></div></div></header><div id="hamburger"><top></top><mid></mid><btm></btm></div><div class="container"><div class="center only-mobile"><h1 class="logo logo--mobile"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1></div><main class="center"><div class="post__tags tags"><a href="/tags/browser/">browser</a></div><h1 class="post__title" id="title">Inside look at modern web browser</h1><div class="post__time"><p><time datetime="2020-09-27">Sep,27 2020・21min read.</time></p></div><aside class="post__toc"><h4 class="only-mobile">TOC</h4><nav class="toc"><ol><li data-header="part1-%E5%BA%95%E5%B1%A4%E8%99%95%E7%90%86%E4%BB%A5%E5%8F%8A%E7%80%8F%E8%A6%BD%E5%99%A8%E6%9E%B6%E6%A7%8B"><a href="#part1-%E5%BA%95%E5%B1%A4%E8%99%95%E7%90%86%E4%BB%A5%E5%8F%8A%E7%80%8F%E8%A6%BD%E5%99%A8%E6%9E%B6%E6%A7%8B">Part1 底層處理以及瀏覽器架構</a><ol><li data-header="cpu%2Fgpu%2C-process%2Fthread"><a href="#cpu%2Fgpu%2C-process%2Fthread">CPU/GPU, Process/Thread</a></li><li data-header="chrome-%E7%9A%84%E9%81%8B%E8%A1%8C%E6%9E%B6%E6%A7%8B"><a href="#chrome-%E7%9A%84%E9%81%8B%E8%A1%8C%E6%9E%B6%E6%A7%8B">Chrome 的運行架構</a></li></ol></li><li data-header="part2-navigation"><a href="#part2-navigation">Part2 Navigation</a><ol><li data-header="%E5%88%A4%E6%96%B7-input"><a href="#%E5%88%A4%E6%96%B7-input">判斷 Input</a></li><li data-header="%E6%B1%BA%E5%AE%9A-body-%E7%9A%84%E8%99%95%E7%90%86%E6%96%B9%E5%BC%8F"><a href="#%E6%B1%BA%E5%AE%9A-body-%E7%9A%84%E8%99%95%E7%90%86%E6%96%B9%E5%BC%8F">決定 body 的處理方式</a></li><li data-header="%E5%AE%89%E5%85%A8%E6%AA%A2%E6%9F%A5"><a href="#%E5%AE%89%E5%85%A8%E6%AA%A2%E6%9F%A5">安全檢查</a></li><li data-header="%E5%85%B6%E4%BB%96-browser-process-%E6%9C%83%E8%99%95%E7%90%86%E7%9A%84%E6%9D%B1%E8%A5%BF"><a href="#%E5%85%B6%E4%BB%96-browser-process-%E6%9C%83%E8%99%95%E7%90%86%E7%9A%84%E6%9D%B1%E8%A5%BF">其他 Browser Process 會處理的東西</a></li><li data-header="service-worker"><a href="#service-worker">Service worker</a></li></ol></li><li data-header="part3-render-pipeline"><a href="#part3-render-pipeline">Part3 Render Pipeline</a><ol><li data-header="paint"><a href="#paint">Paint</a></li><li data-header="composite"><a href="#composite">Composite</a></li><li data-header="%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96"><a href="#%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96">效能優化</a></li></ol></li><li data-header="part4-input-%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%A7%B8%E7%99%BC"><a href="#part4-input-%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%A7%B8%E7%99%BC">Part4 input 事件的觸發</a><ol><li data-header="%E6%88%91%E5%80%91%E7%9A%84%E6%93%8D%E4%BD%9C%E6%80%8E%E9%BA%BC%E8%A7%B8%E7%99%BC-event"><a href="#%E6%88%91%E5%80%91%E7%9A%84%E6%93%8D%E4%BD%9C%E6%80%8E%E9%BA%BC%E8%A7%B8%E7%99%BC-event">我們的操作怎麼觸發 event</a></li><li data-header="passive%3Atrue-%E5%B8%B6%E4%BE%86%E7%9A%84-preventdefault()-%E5%BB%B6%E9%81%B2%E5%95%8F%E9%A1%8C"><a href="#passive%3Atrue-%E5%B8%B6%E4%BE%86%E7%9A%84-preventdefault()-%E5%BB%B6%E9%81%B2%E5%95%8F%E9%A1%8C">passive:true 帶來的 preventDefault() 延遲問題</a></li><li data-header="event-delegation-%E7%9A%84%E6%95%88%E8%83%BD%E5%95%8F%E9%A1%8C"><a href="#event-delegation-%E7%9A%84%E6%95%88%E8%83%BD%E5%95%8F%E9%A1%8C">event delegation 的效能問題</a></li><li data-header="%E9%80%A3%E7%BA%8C%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%AF%80%E6%B5%81"><a href="#%E9%80%A3%E7%BA%8C%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%AF%80%E6%B5%81">連續事件的節流</a></li><li data-header="%E7%B6%B2%E7%AB%99%E5%84%AA%E5%8C%96"><a href="#%E7%B6%B2%E7%AB%99%E5%84%AA%E5%8C%96">網站優化</a></li></ol></li><li data-header="%E5%BE%8C%E8%A8%98"><a href="#%E5%BE%8C%E8%A8%98">後記</a></li></ol></nav></aside><article class="post__content"><p>大概看完了<a href="https://developers.google.com/web/updates/2018/09/inside-browser-part1">這個</a>系列，想寫一下筆記，現在這個程度看這個文章資訊量還對我來說還是蠻驚人的，雖然 Huli 會說當作科普來看就好，但還是做個筆記吧 XD。不然自己一定會忘記的。</p><p>先概覽一下四個章節分別在講什麼：</p><p>Part1 會講解說 CPU/GPU 各自的功用，還有講解 Process / Thread 之間的差異，而講解這些是為了理解說 chrome multi Process 的設計以及各個 Process 的分工。</p><p>Part2 跟 Part3 會講到我覺得比較重要的部分。Part2 是從輸入瀏覽器到拿到 response 渲染前（這個階段稱作 navigation），Part3 則是從渲染。</p><p>Part4 主要是提到說事件的觸發跟處理，瀏覽器怎麼樣對事件做優化，還有一些在事件上我們可以做的優化部分。</p><p>大概是這樣，了解一下大概的架構，可能會比較好理解自己在哪裡還有在講什麼，比較有安全感，人總是會對未知感到恐懼。</p><h2 id="part1-%E5%BA%95%E5%B1%A4%E8%99%95%E7%90%86%E4%BB%A5%E5%8F%8A%E7%80%8F%E8%A6%BD%E5%99%A8%E6%9E%B6%E6%A7%8B"><a href="#part1-%E5%BA%95%E5%B1%A4%E8%99%95%E7%90%86%E4%BB%A5%E5%8F%8A%E7%80%8F%E8%A6%BD%E5%99%A8%E6%9E%B6%E6%A7%8B" class="direct-link">#</a> Part1 底層處理以及瀏覽器架構</h2><h3 id="cpu%2Fgpu%2C-process%2Fthread"><a href="#cpu%2Fgpu%2C-process%2Fthread" class="direct-link">#</a> CPU/GPU, Process/Thread</h3><p>CPU 跟 GPU，常玩電腦組裝的應該蠻了解的。</p><ul><li>CPU 可以處理任何計算，但是單次處理量較少</li><li>GPU 只能處理特定簡單的運算，但是處理量很大</li></ul><p>在網路上有看到有趣的比喻：</p><blockquote><p>GPU是一群小学生，扎堆算加减法；CPU是一个老教授，能解微积分。CPU的核比GPU复杂得多呢。</p></blockquote><p>這裡要理解的是 CPU 跟 GPU 各有所長，而瀏覽器也會利用他們不同的特性來做不同的運算。接下來我們要理解 Process （程序） 跟 Thread （執行緒）的差異。</p><p>Process 裡面會有很多 Thread。OS 會分配資源給 Process，而 Process 裡面的 thread 可以共享這些資源以及共享彼此間的資訊，但 Process 間的資訊交換就必須透過 IPC (Inter Process Communication)</p><p>上面這些都是關於電腦運作比較底層的基本知識，也必須要先知到這些才有辦法了解 chrome 瀏覽器的運行架構。</p><h3 id="chrome-%E7%9A%84%E9%81%8B%E8%A1%8C%E6%9E%B6%E6%A7%8B"><a href="#chrome-%E7%9A%84%E9%81%8B%E8%A1%8C%E6%9E%B6%E6%A7%8B" class="direct-link">#</a> Chrome 的運行架構</h3><p>chrome 採 multi Process 架構。一個瀏覽器會有很多不同的任務，像是網路連線、UI、儲存還有每個 site 畫面的 render 等等的。而 Chrome 將這些不同的任務交給不同 Process 處理。這樣做的優點是當一個 Process 出問題時，直接關掉那個 Process 就可以，不會影響到其他 Process，舉例來說，Chrome 本身一個網頁的 render 就會作為一個 process，假設其中一個分頁當機了，就算關掉也不會造成影響。</p><p>另一個好處是安全性，Process 間沒辦法輕易地共享資料，將分頁獨立出來可以防止讀取到其他分頁的資料。而這也是 chrome 本身使用 site Isolation 的原因，render Process 是以 site 也就是網頁為單位，如果頁面裡面有 iframe，那iframe 也會獨立成另一個 Process ，這樣可以防止 iframe 的 site 存取到頁面的資料。</p><p>採 Multi Process 的缺點也是顯而易見，就是耗費資源（也是全世界都在詬病的點），尤其是 renderer Process，每一個 Process 都需要一具 V8 engine 才有辦法運行（不是汽車的 V8）。當硬體資源有限的時候，chrome 會把同一個 來源但不同分頁的 site 放進同一個 Process，用來兼顧安全性以及資源。</p><p>除此之外，chrome 也可以透過將 Process Servicification（服務化），可以讓 Process 變成 thread 再組合成一個 process 來節省資源。</p><h2 id="part2-navigation"><a href="#part2-navigation" class="direct-link">#</a> Part2 Navigation</h2><p>先講講說大家對於瀏覽器平常的認識。把網址輸入 address bar，像是 <code>www.google.com</code>，然後瀏覽器 tab 上面的 icon 會先轉轉轉，然後跳出頁面之後，就轉好了。</p><p>上面是一般人的理解，身為前端工程師一定要知道的多一點。</p><p>我們知道說當我們輸入 <code>www.google.com</code> 之後會先送到 DNS server 拿 IP，然後我們再用 IP 連到 server，並且送出 request。等我們收到 server 的 response 之後，瀏覽器會把我們收到的 response（先假設是 html） 解析成我們看到的網頁。</p><p>不過還有一點是，現在 address bar 也可以當作 search bar，當你直接打 <code>google</code> ，就會跑出 <code>google</code> 的 google 搜尋結果，不過道理跟上面一樣，只是瀏覽器會幫你連到 google 的搜尋結果而已。</p><p>現在可以了解更底層的東西，就是瀏覽器幫我們做了什麼，然後是瀏覽器的哪個部分去處理的，然後是這些部分是怎麼樣交換訊息。</p><p>我們可以先把 Navigation 這個階段大概切成幾個步驟，但是這幾個步驟不一定是先後關係，有些可能是平行的。</p><ul><li>處理 adress bar 的 Input</li><li>檢查 Input 有沒有對應的 cache 或者是 service worker</li><li>送出 request</li><li>初始化 renderer Process</li><li>確定 type 並檢查 Body</li></ul><h3 id="%E5%88%A4%E6%96%B7-input"><a href="#%E5%88%A4%E6%96%B7-input" class="direct-link">#</a> 判斷 Input</h3><p>一樣的開始：輸入網址列。網址列本身是由 Browser Process 裡面的 UI thread 所處理的。Browser Process 處理網頁畫面（渲染）以外的所有東西，像是前面講到的瀏覽器 UI、儲存、網路等等...</p><p>UI thread 會讀取你的 input，然後看你輸入的是不是 url，然後開始轉圈圈，接著他會初始化一個 network call，選擇適合的 protocal，接著就把資料丟到 network thread 去處理（這裡詳細的分工可能還是要看一下 docs 或者是 source code）。</p><h3 id="%E6%B1%BA%E5%AE%9A-body-%E7%9A%84%E8%99%95%E7%90%86%E6%96%B9%E5%BC%8F"><a href="#%E6%B1%BA%E5%AE%9A-body-%E7%9A%84%E8%99%95%E7%90%86%E6%96%B9%E5%BC%8F" class="direct-link">#</a> 決定 body 的處理方式</h3><p>server 端的事情不講了，當我們收到 reaponse 之後，有一個東西會決定 response body 要清蒸還是要紅燒，那就是 content-type。瀏覽器會根據 response header 裡面的 content-type 還有 body 的內容（因為 content-type 可能會不見或者是出問題，還是要自己判斷 body 比較準 ）來<a href="https://source.chromium.org/chromium/chromium/src/+/master:net/base/mime_sniffer.cc;l=131">判斷</a>說要怎麼處理，像是圖片的就會跑出圖片、檔案就會進行下載，不同的格式會有不同的處理方式。chromium 相較於各<s>小</s>大瀏覽器比較晚出現，因此這方面也參考了前人的做法，但最後只有 html 的內容才會被進行 render。</p><h3 id="%E5%AE%89%E5%85%A8%E6%AA%A2%E6%9F%A5"><a href="#%E5%AE%89%E5%85%A8%E6%AA%A2%E6%9F%A5" class="direct-link">#</a> 安全檢查</h3><p>值得注意的部分，在這個階段也會檢查 body 有沒有連到怪怪的檔案或者是連到惡意的連結（應該是會有一個 black-list），並且會執行 <a href="https://www.chromium.org/Home/chromium-security/corb-for-developers">CORB</a>（目前看下來這個功能是擋掉一些可疑的 request 方式跟 content-type 還有 body 格式的組合），在想這個部分做的可能不只這些，像是 CORS 的檢查可能也是這部分處理的，真的沒問題才放 response 通過。</p><p>通過之後，network thread 通知 UI thread，而 UI thread 會開啟一個 renderer process，這裡有一種 UI thread 像是主控的感覺？不過我不清楚說是不是在架構設計裡就應該要以 UI 作為整個程式的主控，對 design pattern 還不熟。這裡有一個可以優化的點，Renderer Process 可以在 request 被送出去的時候就同步初始化，先處理一些不需要 response 的部分，等 response 到了之後就可以直接處理 Response。</p><p>當 renderer Process 跟 Response 都 OK 之後就可以 GOGO 了，但是要要記得資料還在 Browser Process 裡面阿，所以要透過我們一開始有提到的 IPC 去傳遞資料給 renderer Process，然後就開始解析囉。</p><h3 id="%E5%85%B6%E4%BB%96-browser-process-%E6%9C%83%E8%99%95%E7%90%86%E7%9A%84%E6%9D%B1%E8%A5%BF"><a href="#%E5%85%B6%E4%BB%96-browser-process-%E6%9C%83%E8%99%95%E7%90%86%E7%9A%84%E6%9D%B1%E8%A5%BF" class="direct-link">#</a> 其他 Browser Process 會處理的東西</h3><p>這裡還有幾個小細節：想一想自己的經驗，假設說網頁跑不出來一直轉，有時候我們會按上一頁返回到上一個頁面。所以我們就可以確定說，歷史紀錄是在 network 拿到 response 之前就確定好的，雖然文章沒有提到，但是我在猜說應該是在初始化 renderer Process 的時候就會處理好歷史紀錄的東西。</p><p>還有當網頁載入完的時候，renderer Process 也會通知 Browser Process，要把網頁的 favicon 顯示出來。</p><p>最後我們不要忘記當我們關閉分頁（site）的時候，Browser 會把我們的網頁放進歷史紀錄裡面做 cache，下次在拜訪這個網頁就可以直接跳出來。</p><p><code>beforeunload</code> 這個事件會在從一個網址導向另一個網址時被觸發，文章裏面有提到，但是覺得沒有很困難，感覺像是小補充而已。</p><h3 id="service-worker"><a href="#service-worker" class="direct-link">#</a> Service worker</h3><p>每次在 Navigation 的時候都會檢查 url 有沒有對應的 Service worker（後面簡稱 SW，讓網頁可以在被關閉的時候也能夠執行程序的東西，推薦<a href="https://medium.com/@kosamari/service-worker-what-are-you-ca0f8df92b65">這篇</a>），有的話就會先執行 SW，因為可能 SW 裡面就有 cache 可以用了，沒有才進行 request。</p><p>但如果 SW 早就決定說不要了怎麼辦，這樣不就會慢了一點嗎？尤其是 SW 又很複雜的時候，所以 FB 就不爽了，直接跟 chrome 說你想個辦法讓 SW 不會影響到 request 送出的速度（超兇的），就這樣有了 <a href="https://developers.google.com/web/updates/2017/02/navigation-preload">Navigation Preload</a> 這個東西，人還是要有靠山說話才能夠大聲啊。</p><h2 id="part3-render-pipeline"><a href="#part3-render-pipeline" class="direct-link">#</a> Part3 Render Pipeline</h2><p>這部分覺得蠻複雜的。但我覺得會是這幾個 Part 裡面最重要的部分，這會大大關係到網頁的效能，你的網頁跑起來卡卡的會跟這部分有很大的關係。</p><p>Render 的中文又叫渲染，自己覺得這個翻譯蠻彆扭的，這個部分會將程式碼（就是 html, css, js）轉化成人類看得懂的文字還有畫面，這個部分分幾個階段，跟上一個 Part 不一樣，有<strong>嚴格的前後關係</strong>，這個步驟會稱作 Render Pipeline。</p><ol><li>Parsing</li><li>Sytle Compute</li><li>Layout</li><li>Paint</li><li>Composite</li></ol><p>首先是 Parsing 解析。這裡的大方向是把 html 的內容解析成 DOM tree，瀏覽器的入口點都是 html 檔案，而瀏覽器會將 html 轉化成瀏覽器還有我們可以操作的形式，那就是 DOM（document object model）。</p><p>tag 有很多種，但是有幾種會影響到我們的 DOM tree，分別是 <code>&lt;script&gt;</code> 還有 <code>&lt;link&gt;</code> 跟 <code>&lt;img&gt;</code> （可能還有其他的）。這些東西會加載其他資源。加載資源要時間的！遇到這種要 request 的東西有個概念：提早做，放旁邊，好了在叫你。在 Navigation 中也是初始化 renderer Process 跟 Request 並行。所以 preload scanner 會先看看有沒有這些 tag，有的話就先交給 browser process （裡面的 network thread）去加載。</p><p>除此之外，<code>&lt;script&gt;</code> 還可能會執行 JS。JS 有可能會改變先前的 DOM tree，所以這裡會先處理 JS 裡面的內容。</p><p>這個部分會影響整個網頁的加載速度很大，若 JS 裡面並沒有會影響 DOM 的內容，可以使用 <code>async</code> 跟 <code>defer</code> 來優化。加載資源也可以透過 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Preloading_content">preload</a> 的 tag 屬性來指定什麼資源要先行加載。</p><p>接下來是 style compute，可以先想一下說 CSS 到底是什麼？ CSS 是一堆規則，他指定了</p><ol><li>套用的範圍</li><li>套用的樣式</li></ol><p>但是 CSS 沒有指定每個 element 要什麼樣式。</p><p>這是視覺化的第一個步驟，計算每個 element 身上要套哪些 CSS（可以從 devtoole 的 compute 看到，有時後會比看 CSS 好用很多）。這部分還會把瀏覽器預設的 CSS 也加上去。</p><p>從這一個步驟開始就是瀏覽器渲染引擎的工作了，想了解更多可以看看<a href="https://lauviah.coderbridge.io/2020/09/26/1-%E5%80%8B-div-%E5%92%8C-4-%E8%A1%8C-css-%E5%B0%B1%E8%83%BD%E6%9B%B4%E4%BA%86%E8%A7%A3%E7%80%8F%E8%A6%BD%E5%99%A8%E6%B8%B2%E6%9F%93%E5%BC%95%E6%93%8E/">小弟之前的文章</a>有提到。</p><p>第二個步驟是 Layout，我會覺得這個步驟很像畫草稿，把所有的元素定位，不需要定位的去掉，額外要定位的東西加進來，而這個部分的結果叫做 Layout tree。</p><p>什麼是不需要的跟另外要定位的？</p><p>像是 <code>display: none</code> 就完全不會在畫面上出現，所以會在這部份去掉，只會留在 DOM 裡面，而偽元素就是 html 上面原本沒有的，就需要額外加上去。</p><blockquote><p>其實自己對這個東西蠻有興趣的，做個註記以後可以看<a href="https://www.youtube.com/watch?v=Y5Xa4H2wtVA">BlinkOn 会议的一些访谈</a></p></blockquote><h3 id="paint"><a href="#paint" class="direct-link">#</a> Paint</h3><p>打好草稿，那下一個步驟當然就是就是塗色了。不，代誌不是像憨人想的那麼簡單，你忘了考慮分層。剛剛我們定位出了每個元素的 2D 位置，但是每個元素就像紙張一樣，上層會遮蓋掉下層。我們必須要處理這個問題才能夠塗色。</p><p>所以瀏覽器會再遍歷一次 Layout tree，看看那些元素屬於上層那些屬於下層，然後得出說：先畫 A, C 再畫 B, D, E 這樣的順序，然後才開始繪製。有點像是一個一個的指令，告訴瀏覽器說先畫出什麼，再畫出什麼，這樣的指令稱作 Paint Record，這也是 Paint 產出的東西。</p><p>這裡的 Paint 我的理解比較不像是開始繪製，而是制定一個繪製的順序。</p><h3 id="composite"><a href="#composite" class="direct-link">#</a> Composite</h3><p>再理解這個步驟之前要先了解一個東西，叫做 Raster（光柵化），</p><p>Chromium 會把所有的元素先分層然繪製出來。接著在合成 viewport 內的內容（這部分建議看文章，或是文章裡的這個<a href="https://developers.google.com/web/updates/images/inside-browser/part3/composit.mp4">動畫</a>，用講得實在是很抽象），就像把整個內容全部都擺好，然後再用一個框來取景。這樣可以讓滾動更加滑順，因為內容都已經擺擺好了，只需要重新合成框框裡面的內容就好了。Composite 裡面又可以分為三個步驟。</p><ol><li>分層</li><li>光柵化</li><li>合成</li></ol><p>第一是分層。這個步驟 rederer Process 的 Main thread 會上一個步驟的 Layout tree 轉化成不同層的 Layer tree，也就是決定說那些東西要畫在同一層。我們可以透過 <code>will-change</code> 這個屬性，來強制幫元素分層，如果是舊的瀏覽器可以使用 <code>translateZ(0)</code>。文中是沒有特別提到說除了上面兩個 CSS 屬性以外有沒有其他分層的依據，不過我猜應該是有，除了強制分層應該也是會有一些基本的分層方式。</p><p>有了 Layer tree 之後，Main thread 會把 Layer tree 的內容交給 composite thread，而 composite thread 會在把每一層的畫面切分之後，再交給 raster thread 進行 raster。</p><p>這部分也會涉及優化，整個 Layer 很大，可能跟網頁一樣大。瀏覽器會優先處理比較靠近視窗的部分（接下來可能會瀏覽到的部分）。而且再切分時還會考慮到使用者可能會放大縮小，會把整個畫面切分成不同的大小再進行 raster。</p><p>Raster 是啥？我們都知道說螢幕是由很多像素所組成的，但是瀏覽器裡面的資料會像這樣：</p><pre><code>from 1,1  
to 10,1
to 10,10
to 1, 10
end 1, 1
</code></pre><p>螢幕是看不懂這個東西的，他只知道什麼座標的像素要呈現什麼顏色。把向量的內容變成螢幕可以呈現的點陣圖像就是 Raster。</p><p>當瀏覽器會每一層都 Raster 好之後，就會開始合成。合成的概念跟 Photoshop 的影像平面化的概念很像，前面我們已經把每一層都 Raster 成點陣影像像這樣：</p><pre><code>                 viewport    
Layer 1     |          ccc     |
Layer 2     |      bbbbbbbbbbbb|bbbb
Layer 3  aaa|aaaaaaaaaaaaaaaaaa|
</code></pre><p>接下來我們只取 viewport 裡面的畫面，然後再把所有 Layer 合成一個畫面，就變成下面這樣：</p><pre><code>composite   |aaaaaaaaaacccbbbbb|
</code></pre><p>到這裡我們就把一個 frame 處理好了，但只是一個。平常我們看影片的大概是一秒 30 張圖？電腦的操作必須要到一秒 60 幀（前面的"張"就是"幀"的意思）才夠滑順，當我們在滾動畫面的時候其實網頁是不斷地執行最後這個 composite 這個動作。但如果你有改變網頁中的元素，那就會需要重新 Parse，然後重新 render 了。</p><h3 id="%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96"><a href="#%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96" class="direct-link">#</a> 效能優化</h3><p>就像剛剛提到的，如果 JS 導致畫面上新增元素，或者是有動畫呢？我們可以從頭檢視 render 的步驟（詳細屬性是甚麼可能要再查詢，這邊只是大致分而已）</p><ol><li>Parsing：html ,JS</li><li>Sytle Computed：CSS seletor</li><li>Layout：layout property</li><li>Paint：Paint property</li><li>Composite： Compositor-Only Properties<ol><li>分層</li><li>raster</li><li>合成畫面</li></ol></li></ol><p>JS 會在最一開始被解析，而不同的 CSS 的屬性會在 render pipeline 的不同階段實現，當我們在利用 JS 新增元素時，Layout 跟 Paint 都需要重新執行（style computed 可能不用，看新增的元素有沒有 CSS）。</p><p>而且從 Parsing 到 Paint的步驟都是在 renderer Process 的 Main thread 處理的，這是一個同步的過程（前面做完後面才能繼續執行）。假設這一個整個 render 畫面的流程超過 1/60 秒呢，尤其是 JS 執行的時間很容易就超過這個時間（JS 會在 Parse 階段就被解析執行）。剛剛有說過要一秒 60 幀我們肉眼才會覺得畫面滑順，如果網頁上有動畫，但 render 的運算速度超過 1/60 秒，那就會造成卡頓。</p><p>要避免 JS 的執行阻塞到 render，理論上可以把 JS 切開來執行，或者是用 web worker 讓 JS 獨立到另外一個 thread。至於純粹 CSS 的 animation 或者是 transition ，大方向是不要影響到大部分流程的重繪，像是可以使用 Compositor-Only Properties：transform 、Opacity來處理動畫，就比使用 top, bottom 等 Layout property 來的節省資源。</p><blockquote><p>在想 render 的步驟可能跟計算機圖學有關，後來發現 illustrator 的輸出也有類似的方法。</p></blockquote><h2 id="part4-input-%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%A7%B8%E7%99%BC"><a href="#part4-input-%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%A7%B8%E7%99%BC" class="direct-link">#</a> Part4 input 事件的觸發</h2><h3 id="%E6%88%91%E5%80%91%E7%9A%84%E6%93%8D%E4%BD%9C%E6%80%8E%E9%BA%BC%E8%A7%B8%E7%99%BC-event"><a href="#%E6%88%91%E5%80%91%E7%9A%84%E6%93%8D%E4%BD%9C%E6%80%8E%E9%BA%BC%E8%A7%B8%E7%99%BC-event" class="direct-link">#</a> 我們的操作怎麼觸發 event</h3><p>接下來要提 input，input 不只是輸入東西而已，所有對網頁的操作對瀏覽器而言都是 input。前端當然很了解哪些東西是 input，畢竟每個學 JS 都會知道 <code>addEventListener</code>。那從瀏覽器的角度看，我們的操作是怎麼觸發 EventListener 的？</p><p>我們可能會以為是某個按鈕的範圍可以接收到我們的 click，錯，這就是菜鳥工程師的自私想法，一點都沒有顧慮到瀏覽器。</p><p>當你進行某個操作時，操作的到的是 Browser Process。也就是你到的是瀏覽器，不是網頁。 Browser Process 會把你點擊到的座標以及事件傳給 Renderer Process。那 Render Process 會怎麼處理呢？</p><p>這裡先等等，我們先看看 Event Listener 是怎麼加進去的。</p><p>當你為 element 加上 Event Listener 之後，Composite thread 會把 element 的範圍登記為 non-fast scrollable region。</p><p>當座標傳進 Render Process 之後會經歷以下步驟</p><ol><li>這個座標是不是在 non-fast scrollable region 裡面</li><li>會透過 Paint Record，查找說這個位置有繪製甚麼元素</li><li>觸發事件</li></ol><p>若 1. 的步驟成立，Compisite thread 就會把 event 丟到 Main thread 處理。所以才會稱作 non-fast scrollable region （非立即滾動區），因為當這個區域中發生事件之後，就必須處理完事件還有 callback 才能夠繼續 render 畫面（還記得 JS 的執行是在 Parse 階段，導致阻礙到後面事件的執行），但是這樣就會造成卡頓，可以加上 <code>passive:true</code> 來讓 callback 不要阻礙到後面程序的執行。</p><p>這邊自己在想說是不是就是讓 callback 變成非同步的意思，讓 render 後續的程序跟 callback 並行執行。我想這應該不是完全沒有風險，還有想到一個情況是有可能還沒 render 好，callback 就跑好，但是又影響到 DOM， 那就又需要重新 render，這樣就會造成浪費資源。</p><h3 id="passive%3Atrue-%E5%B8%B6%E4%BE%86%E7%9A%84-preventdefault()-%E5%BB%B6%E9%81%B2%E5%95%8F%E9%A1%8C"><a href="#passive%3Atrue-%E5%B8%B6%E4%BE%86%E7%9A%84-preventdefault()-%E5%BB%B6%E9%81%B2%E5%95%8F%E9%A1%8C" class="direct-link">#</a> passive:true 帶來的 preventDefault() 延遲問題</h3><p>文中還有提到一個狀況是說，如果你將 callback 和 render 同步運行。那麼在 callback 還沒執行到 preventDefault() 時，預設的事件可能就已經送出了，文中的是用橫向的 pointermove（觸控螢幕的滑動） 來舉例。</p><pre><code>document.body.addEventListener('pointermove', event =&gt; {
    if (event.cancelable) { //cancelable 只是為了確認說這個 event 能不能取消
        event.preventDefault(); // block the native scroll
        /*
        *  do what you want the application to do here
        */
    }
}, {passive: true});
</code></pre><p>為了不讓預設的垂直滾動運行，我們會執行 preventDefault()，而且又為了可以讓橫向滾動更滑順而加了 <code>passive: true</code>。但卻因為 <code>passive: true</code> 的關係，不會等待 JS 運行，導致說 JS 可能還沒運行到 event.preventDefault()，來阻止預設的垂直滾動行為，就先進行後面 render 的步驟，viewport （畫面）就會先向下滾動。</p><pre><code>原本的狀況
|---------preventDefault()--------||----scroll-----|
JS                                  後面的 render步驟

passive:true
|----scroll-----|
|---------preventDefault()--------|
scroll 先被觸發了，才進行進行 preventDefault()
</code></pre><p>要解決這樣的狀況，可以直接使用 <code>touch-action: pan-x</code> 直接禁止掉橫向移動。其他事件也是同樣道理，可以找到禁止 event 的 CSS。</p><h3 id="event-delegation-%E7%9A%84%E6%95%88%E8%83%BD%E5%95%8F%E9%A1%8C"><a href="#event-delegation-%E7%9A%84%E6%95%88%E8%83%BD%E5%95%8F%E9%A1%8C" class="direct-link">#</a> event delegation 的效能問題</h3><p>另外一個要知道的是 event delegation。如果你在母元素上加上 listener，相當是把整個母元素都變成 non-fast scrollable region。就變成要隨時監聽母元素的 event，但範圍太大（你把 body 設為 delegation），就會非常的耗費資源。</p><h3 id="%E9%80%A3%E7%BA%8C%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%AF%80%E6%B5%81"><a href="#%E9%80%A3%E7%BA%8C%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%AF%80%E6%B5%81" class="direct-link">#</a> 連續事件的節流</h3><p>像是滑鼠滾動、移動等等的事件，滑鼠一秒會觸發大概一百次，這些是見我們稱為 continuous events（連續事件） ，這個數字超過我們螢幕更新的頻率，為了節省資源，瀏覽器會把 1/60 秒內的事件合併成一次，這種把一定時間內的觸發事件合併成一次來節省資源的模式稱作 throttle（節流）。</p><p>但節流不一定是好的，假設我們在做一些繪圖軟體，反而會因為觸發事件被合併，而忽略了一些細節，在 event 中，我們可以用 event.getCoalescedEvents() 來獲得原始的數據：</p><pre><code>window.addEventListener('pointermove', event =&gt; {
    const events = event.getCoalescedEvents();
    for (let event of events) {
        const x = event.pageX;
        const y = event.pageY;
    }
});
</code></pre><p>從這個 API 看來，每一次的 event 其實都會被監聽到，但是會有一個 throttle 來降低觸發的頻率（忽略一些觸發）。而 <code>event.getCoalescedEvents()</code> 就是可以跳過 throttle 的控制，直接接受 event。</p><h3 id="%E7%B6%B2%E7%AB%99%E5%84%AA%E5%8C%96"><a href="#%E7%B6%B2%E7%AB%99%E5%84%AA%E5%8C%96" class="direct-link">#</a> 網站優化</h3><p>其實講那麼多，為什麼我們要理解瀏覽器？無非就是想要優化網站的性能。但是要優化總不能以順不順這種主觀的感受來判斷，文中也提供了一些資源：</p><ul><li><p>LighHouse 可以幫你的網站評分，來告訴你說你的網站有哪些做的比較不好而且可以怎麼改善，打開 Devtools 的更多工具就可以用了，而且不只效能優化，還有 Web accessibility, SEO 等等指標</p></li><li><p><a href="https://developers.google.com/web/tools/chrome-devtools/speed/get-started">Optimize Website Speed With Chrome DevTools</a> 來看說怎麼用 Devtools 來優化網頁效能。</p></li><li><p><a href="https://developers.google.com/web/updates/2018/06/feature-policy">Feature Policy</a> 裡面告訴你說一些網頁的雷不要踩。</p></li></ul><h2 id="%E5%BE%8C%E8%A8%98"><a href="#%E5%BE%8C%E8%A8%98" class="direct-link">#</a> 後記</h2><p>原本只是想做個筆記的，沒想到打了蠻多東西的，這篇文章不是什麼很嚴謹的內容，更不是什麼把很難的內容變得簡單那種很偉大的東西，只是自己對於這幾篇文章思考的結果而已。</p><p>瀏覽器的東西博大精深，這是篇很好的入門點，身為菜鳥工程師的自己看完這幾篇也覺得說自己的腦袋炸了，如果這一篇能夠幫助到和我一樣的人真是再好不過了。</p><p>參考資料： <a href="https://juejin.im/post/6844903695600058375">[译] 现代浏览器内部揭秘（第四部分）</a> <a href="https://juejin.im/post/6844903692894732295">[译] 现代浏览器内部揭秘（第三部分）</a> <a href="https://juejin.im/post/6844903692890537992">[译] 现代浏览器内部揭秘（第二部分）</a> <a href="https://juejin.im/post/6844903679389073415">[译] 现代浏览器内部揭秘（第一部分）</a> <a href="https://developers.google.com/web/updates/2018/09/inside-browser-part1">Inside look at modern web browser (part 1)</a> <a href="https://developers.google.com/web/updates/2018/09/inside-browser-part2">Inside look at modern web browser (part 2)</a> <a href="https://developers.google.com/web/updates/2018/09/inside-browser-part4">Inside look at modern web browser (part 3)</a> <a href="https://developers.google.com/web/updates/2018/09/inside-browser-part4">Inside look at modern web browser (part 4)</a></p></article><div class="post__tags tags"><h2>tags</h2><a href="/tags/browser/">browser</a></div><div class="post__link"><div><span>Prev</span><a href="/posts/1-div-4-css/" class="">1 個 div 和 4 行 CSS 就能更了解瀏覽器渲染引擎</a></div><div><span>Next</span><a href="/posts/mini-jsonp/" class="">[極短篇] JSONP</a></div></div><hr class="post__devider"><div class="utterances"></div><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" issue-term="title" label="utterance" repo="Lauviah0622/Lavi-blog" theme="github-light"></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Inside look at modern web browser",
  "image": [],
  "author": "Lavi", 
  "genre": "Insert a schema.org genre", 
  "publisher": {
    "@type": "Organization",
    "name": "Lavi",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/favicon/favicon-192x192.png?hash=46a52117ad"
    }
  },
  "url": "https://lavi-blog.vercel.app/posts/inside-look-modern-browser/",
  "mainEntityOfPage": "https://lavi-blog.vercel.app/posts/inside-look-modern-browser/",
  "datePublished": "2020-09-27",
  "dateModified": "2021-10-27",
  "description": "大概看完了這個系列，想寫一下筆記，現在這個程度看這個文章資訊量還對我來說還是蠻驚人的，雖然 Huli 會說當作科普來看就好，但還是做個筆記吧 XD。不然自己一定會忘記的。 先概覽一下四個章節分別在講什麼： Part1 會講解說 CPU/GPU 各自的功用，還有講解 Process..."
}</script><script csp-hash="sha256-Fc9RvR5cQc4eds/61y5EGXrmOqQOE0YF/KJfE7B/NJs=">let prevElement;
 const io = new IntersectionObserver(
  (entries) => {
    entries.forEach((entry) => {
      const id = entry.target.id
        if (id === "title") {
          const title = document.querySelector(`#${id}`)
          if (prevElement) {
            prevElement.classList.remove('current');
          }
          return  
        }
        const current = document.querySelector(`[data-header="${id}"]`);
        if (current == null) return 
        if (entry.isIntersecting) {
          current.classList.add('current');
          

          let scrollTo = current.offsetTop - 100;
          current.offsetParent.scrollTo(0, scrollTo < 0 ? 0 : scrollTo);
          if (prevElement && prevElement != current) {
            prevElement.classList.remove('current');
          }
          prevElement = current
        }
        
    });
  },
  {
    rootMargin: "-10% 0% -70% 0%",
  }
);

// Declares what to observe, and observes its properties.
const boxElList = document.querySelectorAll('h1, h2, h3, h4');
boxElList.forEach((el) => {
    io.observe(el);
})</script></main><footer class="center center--wide"><div class="footer"><div><nav class="nav"><h1 class="logo"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1><a href="/posts/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></nav></div><div class="caption footer__info"><div><a href="https://github.com/Lauviah0622" target="_blank"><svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M12.026 2C7.13295 1.99937 2.96183 5.54799 2.17842 10.3779C1.395 15.2079 4.23061 19.893 8.87302 21.439C9.37302 21.529 9.55202 21.222 9.55202 20.958C9.55202 20.721 9.54402 20.093 9.54102 19.258C6.76602 19.858 6.18002 17.92 6.18002 17.92C5.99733 17.317 5.60459 16.7993 5.07302 16.461C4.17302 15.842 5.14202 15.856 5.14202 15.856C5.78269 15.9438 6.34657 16.3235 6.66902 16.884C6.94195 17.3803 7.40177 17.747 7.94632 17.9026C8.49087 18.0583 9.07503 17.99 9.56902 17.713C9.61544 17.207 9.84055 16.7341 10.204 16.379C7.99002 16.128 5.66202 15.272 5.66202 11.449C5.64973 10.4602 6.01691 9.5043 6.68802 8.778C6.38437 7.91731 6.42013 6.97325 6.78802 6.138C6.78802 6.138 7.62502 5.869 9.53002 7.159C11.1639 6.71101 12.8882 6.71101 14.522 7.159C16.428 5.868 17.264 6.138 17.264 6.138C17.6336 6.97286 17.6694 7.91757 17.364 8.778C18.0376 9.50423 18.4045 10.4626 18.388 11.453C18.388 15.286 16.058 16.128 13.836 16.375C14.3153 16.8651 14.5612 17.5373 14.511 18.221C14.511 19.555 14.499 20.631 14.499 20.958C14.499 21.225 14.677 21.535 15.186 21.437C19.8265 19.8884 22.6591 15.203 21.874 10.3743C21.089 5.54565 16.9181 1.99888 12.026 2Z" fill="#2E3A59"></path></svg></a></div><p>© 2020-present Lavi. All Rights Reserved.<br>This website based on <a href="https://www.industrialempathy.com/posts/eleventy-high-performance-blog/">eleventy-high-performance-blog</a>.</p></div></div></footer></div><script csp-hash="sha256-AvHvdkAvA2liH7FoblyZGebwmSzE3eLp/zZiYQ+l2Qk=">const dark = document.querySelector('#dark');
      const light = document.querySelector('#light');
      dark.addEventListener('click', () => {
        document.body.classList.add('dark-theme')
        localStorage.setItem("theme", 'dark')
        setUtterancesTheme('dark');
      })
      light.addEventListener('click', () => {
        document.body.classList.remove('dark-theme')
        localStorage.setItem("theme", 'light')
        setUtterancesTheme('light');
      })
      const ham = document.querySelector('#hamburger');
      ham.addEventListener('click', () => {
        document.querySelector('header').classList.toggle('open')
        ham.classList.toggle('open');
      })</script></body></html>