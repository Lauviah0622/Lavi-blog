<!DOCTYPE html><html domain="lavi-blog.vercel.app" lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="default-src 'self';object-src 'none';script-src 'self' 'sha256-Ky9qZOPnMhQV/s7Fdb9TYAOfU4KtWNqCZaFK8tSzXa0=' 'sha256-za/u+GpTRqxVmtY0/RJrU1alkYqdlDRMaW2bCpySaa8=' 'sha256-S74q1WGEGfQZyLlS1Dzl4+dKEQ+b0Z0yGiPJt7XNB5k=' 'sha256-AvHvdkAvA2liH7FoblyZGebwmSzE3eLp/zZiYQ+l2Qk=' https://utteranc.es/client.js;style-src 'unsafe-inline' 'self';img-src 'self' data:;frame-src https://utteranc.es/;font-src https://fonts.googleapis.com/ 'self'" http-equiv="Content-Security-Policy"><link href="/img/favicon/favicon-192x192.png?hash=2089033c93" rel="icon" type="image/png"><meta content="#f9c412" name="theme-color"><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name="robots"><title>React Ref 的一點研究</title><meta content="React Ref 的一點研究" property="og:title"><meta content="# React Ref 的一點研究 A JavaScript library for building user interfaces React 是狀態和 UI 的 Library 我們都知道，使用了 React 可以這樣思考：每一個狀態都會產生出對應的 UI。使用了..." name="description"><meta content="# React Ref 的一點研究 A JavaScript library for building user interfaces React 是狀態和 UI 的 Library 我們都知道，使用了 React 可以這樣思考：每一個狀態都會產生出對應的 UI。使用了..." property="og:description"><meta content="summary_large_image" name="twitter:card"><meta content="@" name="twitter:site"><meta content="@" name="twitter:creator"><link href="https://lavi-blog.vercel.app/posts/react-ref-reference/" rel="canonical"><meta content="no-referrer-when-downgrade" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Apprentice Log"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=c909e7f885" defer=""></script><script csp-hash="sha256-Ky9qZOPnMhQV/s7Fdb9TYAOfU4KtWNqCZaFK8tSzXa0=">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */
*,::after,::before{box-sizing:border-box}html{-moz-tab-size:4;-o-tab-size:4;tab-size:4;line-height:1.15;-webkit-text-size-adjust:100%;font-size:var(--font-base-size);width:100vw;letter-spacing:.04ch}body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji';--color-primary:var(--light-primary);--color-secondary:var(--light-secondary);--color-text:var(--light-text);--color-text-reverse:var(--dark-text);--color-text-secondary:var(--light-text-secondary);--color-bg:hsl(var(--light-bg));--color-bg-reverse:var(--dark-bg);--color-bg-opacity:hsla(var(--light-bg), 0.9);--color-bg-secondary:var(--light-bg-grey);--font-weight-normal:400;background-color:var(--color-bg);color:var(--color-text);overflow-x:hidden}hr{height:0;color:inherit;margin:3rem auto;width:95%}code,pre{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace}button,input{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button{text-transform:none}[type=button],button{-webkit-appearance:button}summary{display:list-item}:root{--primary-hue:200;--primary-saturation:20%;--primary-light:60%;--secondary-hue:22;--secondary-saturation:85%;--text-hue:200;--text-saturation:10%;--text-light:10%;--light-primary:hsl(
      var(--primary-hue),
      var(--primary-saturation),
      var(--primary-light)
    );--light-secondary:hsl(
      var(--secondary-hue),
      var(--secondary-saturation),
      60%
    );--light-text:hsl(var(--text-hue), var(--text-saturation), var(--text-light));--light-text-secondary:hsl(var(--primary-hue), var(--text-saturation), 45%);--light-bg:0, 0%, 98%;--light-bg-grey:hsl(var(--primary-hue), var(--primary-saturation), 90%);--dark-bg:hsl(var(--primary-hue), 15%, 5%);--dark-bg-reverse:hsl(var(--primary-hue), 20%, 20%);--dark-bg-opacity:hsla(var(--primary-hue), var(--primary-saturation), 5%, 95%);--dark-bg-grey:hsl(var(--primary-hue), var(--primary-saturation), 15%);--dark-text:hsl(var(--text-hue), 30%, 90%);--dark-text-secondary:hsl(var(--primary-hue), 35%, 70%);--font-base-size:18px;--font-family-serif:Lora, Georgia, Songti TC, Hiragino Mincho Pro, serif;--font-family-mono:"DM mono", monospace, "Kosugi Maru", "Noto Sans TC",
      sans-serif;--block-border-radius:1ch}body.dark-theme{--color-primary:var(--light-primary);--color-secondary:var(--light-secondary);--color-text:var(--dark-text);--color-text-reverse:var(--dark-text);--color-text-secondary:var(--dark-text-secondary);--color-bg:var(--dark-bg);--color-bg-reverse:var(--dark-bg-reverse);--color-bg-opacity:var(--dark-bg-opacity);--color-bg-secondary:var(--dark-bg-grey);--font-weight-normal:300}@font-face{font-display:optional;font-family:"Inter UI";font-style:normal;font-weight:400;src:url(/fonts/Inter-Regular.woff2) format("woff2"),url(/fonts/Inter-Regular.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:italic;font-weight:400;src:url(/fonts/Inter-Italic.woff2) format("woff2"),url(/fonts/Inter-Italic.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:normal;font-weight:600;src:url(/fonts/Inter-SemiBold.woff2) format("woff2"),url(/fonts/Inter-SemiBold.woff) format("woff")}@font-face{font-display:optional;font-family:"Inter UI";font-style:italic;font-weight:600;src:url(/fonts/Inter-SemiBoldItalic.woff2) format("woff2"),url(/fonts/Inter-SemiBoldItalic.woff) format("woff")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-style:normal;src:url(/fonts/Lora-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-style:italic;src:url(/fonts/Lora-Italic.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-weight:600;font-style:italic;src:url(/fonts/Lora-SemiBold.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Lora";font-display:swap;font-weight:600;font-style:italic;src:url(/fonts/Lora-SemiBoldItalic.ttf) format("truetype")}@font-face{font-display:optional;font-family:"DM mono";font-display:swap;font-style:normal;src:url(/fonts/DMMono-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"DM mono";font-display:swap;font-style:italic;src:url(/fonts/DMMono-Regular.ttf) format("truetype")}@font-face{font-display:optional;font-family:"Kosugi Maru";font-display:swap;src:url(https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap)}@font-face{font-display:optional;font-family:"Inter UI var";font-weight:100 900;font-style:oblique 0deg 10deg;src:url(/fonts/Inter.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"Inter UI var alt";font-weight:100 900;font-style:normal;font-named-instance:"Regular";src:url(/fonts/Inter-roman.var.woff2) format("woff2")}@font-face{font-display:optional;font-family:"Inter UI var alt";font-weight:100 900;font-style:italic;font-named-instance:"Italic";src:url(/fonts/Inter-italic.var.woff2) format("woff2")}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1}*{transition:background-color .1s,color .1s}h1,h2,h3,h4,p{text-decoration:none;font-weight:var(--font-weight-normal);margin:0}h1,h2,h3,h4{line-height:1.2}blockquote,li{font-weight:var(--font-weight-normal)}h1{font-size:2rem;padding:3rem 0 1.6rem}h2{font-size:1.6rem;padding:2rem 0 .8rem}h3{font-size:1.4rem;padding:1.6rem 0 .8rem}h4{font-size:1.2rem;padding:1.2rem 0 .8rem}.icon,.icon path{fill:var(--color-primary)}a{text-decoration:none}a:hover{text-decoration:underline}main{margin:50px 0 100px}.caption,.caption a,a{color:var(--color-text-secondary)}.caption,.caption a{font-size:.6rem}.caption a,.post__toc li:hover>a{text-decoration:underline}.tags a::before{content:"#"}.tags{text-transform:capitalize}s{-webkit-text-decoration-color:var(--color-text-secondary);text-decoration-color:var(--color-text-secondary)}blockquote{position:relative;padding:2rem;padding-right:0;margin:1.2rem 0;font-family:var(--font-family-serif)}blockquote::before{top:0;left:0;content:"";position:absolute;display:block;height:100%;width:5px;background-color:var(--color-primary);border-radius:2px}code{font-size:.9em;font-family:var(--font-family-mono)}:not(pre)>code{display:inline-block;padding:.2ch;background-color:var(--color-bg-reverse);color:var(--color-text-reverse);border-radius:.4ch;margin:0 .4ch;line-height:1.1rem}dialog,pre{background-color:var(--color-bg-reverse)}pre{color:var(--color-text-reverse);margin:1.2rem -2rem;padding:1.2rem 2rem;border-radius:var(--block-border-radius);font-size:.9em;line-height:inherit;overflow-x:scroll}dialog{position:fixed;bottom:0;z-index:9999;color:var(--color-secondary);width:100vw;border-width:0;text-align:center;height:-webkit-min-content;height:-moz-min-content;height:min-content}body:not(.dark-theme) #light{display:none}body.dark-theme #dark{display:none}body.dark-theme #light{display:block}body.dark-theme img{filter:brightness(.8) contrast(1.2)}@media (prefers-color-scheme:dark){#light{display:block}img{filter:brightness(.8) contrast(1.2)}}@media (prefers-color-scheme:light){#dark{display:block}}.center{--max-width:63ch;width:100%;display:grid;grid-template-columns:1fr min(var(--max-width),calc(100% - 64px)) 1fr}.center>*{grid-column:2}.center--wide{--max-width:1040px}body .container{display:grid;min-height:100vh;grid-template-rows:auto -webkit-max-content;grid-template-rows:auto max-content}header{top:0;position:sticky;display:flex;align-items:flex-end;margin-top:50px;padding:8px 0 15px;background-color:var(--color-bg);z-index:1}header p{margin-top:0}header>div{width:100%;display:flex;align-items:baseline;justify-content:space-between}#hamburger,.only-mobile{display:none}#hamburger{position:fixed;pointer-events:auto;--hamburger-size:2rem;height:var(--hamburger-size);width:var(--hamburger-size);margin:1.5rem;right:0;z-index:999}#hamburger>*{display:block;width:80%;height:calc(var(--hamburger-size)*.08);background-color:var(--color-primary);position:absolute;top:50%;left:50%;transition:all 400ms cubic-bezier(.84,.06,.52,1.8);transform-origin:center}#hamburger top{transform:translate(-50%,calc(var(--hamburger-size)*.25))}#hamburger mid{transform:translate(-50%,0)}#hamburger btm{transform:translate(-50%,calc(var(--hamburger-size)*-.25))}#hamburger.open top{transform:translate(-50%,0) rotate(45deg)}#hamburger.open mid{opacity:0}#hamburger.open btm{transform:translate(-50%,0) rotate(-45deg)}.header__items,nav{display:flex;align-items:center}.header__items>*{margin:0 .6rem}.header__items svg{height:1rem;width:1rem}.header__theme{height:1rem;overflow:visible}#rss{height:1.2rem;width:1.2rem}nav{align-items:baseline;gap:1.5rem}nav>a{font-size:1rem;font-weight:400;color:var(--color-text-secondary)}.logo{margin:0;padding:0;font-size:1.4rem;text-align:left}.logo a{margin:0;color:var(--color-text)}.logo svg{height:1.5em;position:relative;top:.3em;margin-right:10px}footer{background-color:var(--color-bg-secondary);padding:2rem 0;height:-webkit-min-content;height:-moz-min-content;height:min-content}.footer{display:flex;justify-content:space-between}.footer__info{text-align:right;display:flex;flex-direction:column;gap:1rem}footer nav{visibility:hidden}@media only screen and (max-device-width:576.98px){.only-mobile{display:inherit}#hamburger{display:block}header{position:fixed;margin-top:0;padding-top:6rem;--transition:all 500ms cubic-bezier(0.075, 0.82, 0.165, 1);transition:var(--transition);pointer-events:auto;opacity:1;background-color:var(--color-bg-opacity);height:100%}header .logo{display:none}header:not(.open){transition:var(--transition);background-color:transparent;pointer-events:none;opacity:0}header>div,nav{flex-direction:column;gap:2rem}header>div{align-items:flex-end;padding-right:2rem;align-self:start}nav{align-items:end}.nav>*{margin:0;font-size:1.2em}.header__items svg{height:1.2em;width:1.2em}.logo--mobile{padding:1.5rem 0;z-index:99}.footer{flex-direction:column}footer nav{visibility:visible}footer nav>.logo,nav{margin-bottom:1rem}}.post__time{font-family:var(--font-family-serif);margin:9px 0 4px}.post__time p,.post__title,article{padding:0}.post__toc{position:fixed;top:50%;padding-left:2rem;transform:translateY(-50%);font-size:.8em}.post__toc ol{list-style-type:none;padding:0 0 0 1ch;width:20ch}.post__toc ol ol{width:100%}.post__toc li{width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:.2em 0}.logo a,.post__toc li a{text-decoration:none}.post__toc .current,.post__toc .current>a{color:var(--color-secondary)}.post__content h1,.post__content h2,.post__content h3,.post__content h4,.post__content h5,.post__content h6{position:relative}.post__content h1 a[href^="#"],.post__content h2 a[href^="#"],.post__content h3 a[href^="#"],.post__content h4 a[href^="#"],.post__content h5 a[href^="#"],.post__content h6 a[href^="#"]{position:absolute;left:-1.4ch}.post__content h1 a:not([href^="#"]),.post__content h2 a:not([href^="#"]),.post__content h3 a:not([href^="#"]),.post__content h4 a:not([href^="#"]),.post__content h5 a:not([href^="#"]),.post__content h6 a:not([href^="#"]){color:inherit;text-decoration:inherit}.post__content li,.post__content p{line-height:1.6}.post__content p{padding:.8rem 0}.post__content li{padding:.2rem 0}.post__content ol,.post__content ul{padding:1.2rem 1rem 1.2rem 1.8rem;font-family:var(--font-family-serif);margin:0}.post__content ol li::marker,.post__content ul li::marker{color:var(--color-text-secondary)}.post__content p~ol,.post__content p~ul{padding-top:0}.post__content ol li::marker{font-size:1.1em}.post__content ol ol,.post__content ol ul,.post__content ul ol,.post__content ul ul{padding:0 1.2rem}.post__content hr{margin-top:4rem;margin-bottom:4rem}.post__content img{max-height:50vh;width:auto;margin:0 auto}.token.comment,.token.doctype{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}.post__link{display:flex;justify-content:space-between;margin-top:2rem}.post__link>div>*{display:block}.post__link>div>span{font-size:.8em;margin-bottom:.2em}.post__link>div:last-of-type span{text-align:right}@media only screen and (max-device-width:576.98px){.post__content img{max-height:30vh}.post__content blockquote{padding:1rem 1.5rem;margin:.6rem 0}.post__content pre{margin-right:0;margin-left:0;padding:1.5rem 2ch;width:calc(100vw - 6ch)}.post__toc{background-color:var(--color-bg-secondary);position:static;transform:none;padding:3ch;border-radius:var(--block-border-radius)}.post__toc h4{padding-top:0}.post__toc nav{align-items:flex-start;font-size:1rem;margin:0}.post__toc ol{padding-left:2rem;width:auto}.post__toc li a{display:inline-block;padding-bottom:.3em}.post__toc li{white-space:normal}.post__toc nav>ol{padding-left:0;margin:0}.post__toc .current,.post__toc a:active,.post__toc a:hover{color:inherit}}</style></head><body><script csp-hash="sha256-za/u+GpTRqxVmtY0/RJrU1alkYqdlDRMaW2bCpySaa8=">let isUtterancesLoaded = false;
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = localStorage.getItem("theme");
      const isDark = currentTheme != null ?　currentTheme === 'dark' : prefersDarkScheme.matches;
      if (isDark) {
          document.body.classList.add('dark-theme');
          setUtterancesTheme('dark');
      } else {  
        document.body.classList.remove('dark-theme');
          setUtterancesTheme('light');
      }
      
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }
        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === 'dark' ? 'dark-blue' : 'github-light'
        }, 'https://utteranc.es');
      }</script><dialog id="message"></dialog><header class="center center--wide"><div><nav class="nav"><h1 class="logo"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1><a href="/tags/">Tags</a> <a href="/about/">About</a></nav><div class="header__items"><div class="header__theme"><svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" id="dark" height="16" width="16"><path d="M6.85141 0.219686C7.03763 0.405907 7.11254 0.676155 7.04875 0.931669C6.92055 1.44524 6.85229 1.98329 6.85229 2.53834C6.85229 6.1886 9.81142 9.14773 13.4617 9.14773C14.0167 9.14773 14.5548 9.07948 15.0683 8.95127C15.3239 8.88749 15.5941 8.96239 15.7803 9.14861C15.9665 9.33483 16.0415 9.60508 15.9777 9.8606C15.0974 13.3869 11.9095 16 8.10939 16C3.6307 16 -1.78814e-07 12.3693 0 7.89062C1.78814e-07 4.09054 2.61311 0.902648 6.13943 0.0223469C6.39495 -0.041439 6.66519 0.0334652 6.85141 0.219686ZM5.37954 1.8693C3.09107 2.90847 1.5 5.21444 1.5 7.89062C1.5 11.5409 4.45913 14.5 8.10939 14.5C10.7856 14.5 13.0915 12.9089 14.1307 10.6205C13.91 10.6385 13.6869 10.6477 13.4617 10.6477C8.98299 10.6477 5.35229 7.01703 5.35229 2.53834C5.35229 2.31317 5.36149 2.09003 5.37954 1.8693Z" fill="black" clip-rule="evenodd" fill-rule="evenodd"></path></svg> <svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" id="light" height="16" width="16"><path d="M8.00006 1.17009e-09C8.41427 2.28894e-05 8.75004 0.335828 8.75001 0.750041L8.74999 1.25004C8.74996 1.66426 8.41416 2.00002 7.99994 2C7.58573 1.99998 7.24996 1.66417 7.24999 1.24996L7.25001 0.749959C7.25004 0.335745 7.58584 -2.2887e-05 8.00006 1.17009e-09ZM2.34319 2.34311C2.6361 2.05023 3.11097 2.05026 3.40385 2.34316L3.75738 2.69674C4.05026 2.98965 4.05023 3.46452 3.75732 3.7574C3.46441 4.05027 2.98954 4.05025 2.69666 3.75734L2.34313 3.40377C2.05025 3.11086 2.05028 2.63598 2.34319 2.34311ZM13.6569 2.34319C13.9498 2.6361 13.9497 3.11097 13.6568 3.40385L13.3033 3.75738C13.0104 4.05026 12.5355 4.05023 12.2426 3.75732C11.9497 3.46441 11.9498 2.98954 12.2427 2.69666L12.5962 2.34313C12.8891 2.05025 13.364 2.05028 13.6569 2.34319ZM8.00026 5.5C6.61955 5.5 5.50026 6.61929 5.50026 8C5.50026 9.38071 6.61955 10.5 8.00026 10.5C9.38097 10.5 10.5003 9.38071 10.5003 8C10.5003 6.61929 9.38097 5.5 8.00026 5.5ZM4.00026 8C4.00026 5.79086 5.79112 4 8.00026 4C10.2094 4 12.0003 5.79086 12.0003 8C12.0003 10.2091 10.2094 12 8.00026 12C5.79112 12 4.00026 10.2091 4.00026 8ZM1.17006e-09 7.99994C2.28894e-05 7.58573 0.335828 7.24996 0.750041 7.24999L1.25004 7.25001C1.66426 7.25004 2.00002 7.58584 2 8.00006C1.99998 8.41427 1.66417 8.75004 1.24996 8.75001L0.749959 8.74999C0.335745 8.74996 -2.2887e-05 8.41416 1.17006e-09 7.99994ZM14 7.99994C14 7.58573 14.3358 7.24996 14.75 7.24999L15.25 7.25001C15.6643 7.25004 16 7.58584 16 8.00006C16 8.41427 15.6642 8.75004 15.25 8.75001L14.75 8.74999C14.3357 8.74996 14 8.41416 14 7.99994ZM12.2427 12.2426C12.5356 11.9497 13.0105 11.9498 13.3033 12.2427L13.6569 12.5962C13.9498 12.8891 13.9497 13.364 13.6568 13.6569C13.3639 13.9498 12.889 13.9497 12.5962 13.6568L12.2426 13.3033C11.9497 13.0104 11.9498 12.5355 12.2427 12.2426ZM3.7574 12.2427C4.05027 12.5356 4.05025 13.0105 3.75734 13.3033L3.40377 13.6569C3.11086 13.9498 2.63598 13.9497 2.34311 13.6568C2.05023 13.3639 2.05025 12.889 2.34316 12.5962L2.69674 12.2426C2.98965 11.9497 3.46452 11.9498 3.7574 12.2427ZM8.00006 14C8.41427 14 8.75004 14.3358 8.75001 14.75L8.74999 15.25C8.74996 15.6643 8.41416 16 7.99994 16C7.58573 16 7.24996 15.6642 7.24999 15.25L7.25001 14.75C7.25004 14.3357 7.58584 14 8.00006 14Z" fill="black" clip-rule="evenodd" fill-rule="evenodd"></path></svg></div><a href="/feed/feed.xml"><svg fill="none" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" class="icon" id="rss"><path d="M3.75 3C3.33579 3 3 3.33579 3 3.75C3 4.16421 3.33579 4.5 3.75 4.5H4.82759C10.7216 4.5 15.5 9.27925 15.5 15.1751V16.25C15.5 16.6642 15.8358 17 16.25 17C16.6642 17 17 16.6642 17 16.25V15.1751C17 8.45116 11.5504 3 4.82759 3H3.75Z"></path><path d="M3 7.19904C3 6.78482 3.33579 6.44904 3.75 6.44904H4.82759C9.64596 6.44904 13.5517 10.356 13.5517 15.1751V16.2499C13.5517 16.6642 13.2159 16.9999 12.8017 16.9999C12.3875 16.9999 12.0517 16.6642 12.0517 16.2499V15.1751C12.0517 11.1841 8.8172 7.94904 4.82759 7.94904H3.75C3.33579 7.94904 3 7.61325 3 7.19904Z"></path><path d="M3.75 9.89813C3.33579 9.89813 3 10.2339 3 10.6481C3 11.0623 3.33579 11.3981 3.75 11.3981H4.82759C6.91277 11.3981 8.60345 13.089 8.60345 15.1751V16.2499C8.60345 16.6642 8.93923 16.9999 9.35345 16.9999C9.76766 16.9999 10.1034 16.6642 10.1034 16.2499V15.1751C10.1034 12.2609 7.74153 9.89813 4.82759 9.89813H3.75Z"></path><path d="M5 13C3.89543 13 3 13.8954 3 15C3 16.1046 3.89543 17 5 17C6.10457 17 7 16.1046 7 15C7 13.8954 6.10457 13 5 13ZM4.5 15C4.5 14.7239 4.72386 14.5 5 14.5C5.27614 14.5 5.5 14.7239 5.5 15C5.5 15.2761 5.27614 15.5 5 15.5C4.72386 15.5 4.5 15.2761 4.5 15Z" clip-rule="evenodd" fill-rule="evenodd"></path></svg></a></div></div></header><div id="hamburger"><top></top><mid></mid><btm></btm></div><div class="container"><div class="center only-mobile"><h1 class="logo logo--mobile"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1></div><main class="center"><div class="post__tags tags"><a href="/tags/react/">react</a></div><h1 class="post__title" id="title">React Ref 的一點研究</h1><div class="post__time"><p><time datetime="2021-09-27">Sep,27 2021・7min read.</time></p></div><aside class="post__toc"><h4 class="only-mobile">TOC</h4><nav class="toc"><ol><li data-header="callback-ref"><a href="#callback-ref">Callback Ref</a><ol><li data-header="callback-ref-%E7%94%A8%E5%9C%A8%E5%93%AA%E8%A3%A1%EF%BC%9F"><a href="#callback-ref-%E7%94%A8%E5%9C%A8%E5%93%AA%E8%A3%A1%EF%BC%9F">Callback Ref 用在哪裡？</a></li></ol></li><li data-header="component-%E7%9A%84-ref"><a href="#component-%E7%9A%84-ref">Component 的 ref</a></li><li data-header="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90">總結</a></li><li data-header="%E4%B8%80%E4%BA%9B%E5%A5%87%E6%80%AA%E7%9A%84%E7%99%BC%E7%8F%BE%E5%92%8C%E7%8C%9C%E6%83%B3"><a href="#%E4%B8%80%E4%BA%9B%E5%A5%87%E6%80%AA%E7%9A%84%E7%99%BC%E7%8F%BE%E5%92%8C%E7%8C%9C%E6%83%B3">一些奇怪的發現和猜想</a><ol><li data-header="%E9%97%9C%E6%96%BC-callback-ref-%E5%92%8C-component-%E6%9C%AC%E8%BA%AB-lifecycle-%E7%9A%84%E9%A0%86%E5%BA%8F"><a href="#%E9%97%9C%E6%96%BC-callback-ref-%E5%92%8C-component-%E6%9C%AC%E8%BA%AB-lifecycle-%E7%9A%84%E9%A0%86%E5%BA%8F">關於 callback ref 和 component 本身 lifecycle 的順序</a></li><li data-header="%E7%B4%94%E6%89%8B%E5%B7%A5-ref"><a href="#%E7%B4%94%E6%89%8B%E5%B7%A5-ref">純手工 ref</a></li><li data-header="%E4%B8%8D%E4%BD%BF%E7%94%A8-useinperativehandle-%E4%BE%86%E5%81%9A%E7%B6%81%E5%AE%9A%E7%9A%84%E8%A9%B1%E6%9C%83%E6%80%8E%E9%BA%BC%E6%A8%A3%EF%BC%9F"><a href="#%E4%B8%8D%E4%BD%BF%E7%94%A8-useinperativehandle-%E4%BE%86%E5%81%9A%E7%B6%81%E5%AE%9A%E7%9A%84%E8%A9%B1%E6%9C%83%E6%80%8E%E9%BA%BC%E6%A8%A3%EF%BC%9F">不使用 useInperativeHandle 來做綁定的話會怎麼樣？</a></li></ol></li><li data-header="%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><a href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99">參考資料</a></li></ol></nav></aside><article class="post__content"><h1 id="react-ref-%E7%9A%84%E4%B8%80%E9%BB%9E%E7%A0%94%E7%A9%B6"><a href="#react-ref-%E7%9A%84%E4%B8%80%E9%BB%9E%E7%A0%94%E7%A9%B6" class="direct-link">#</a> React Ref 的一點研究</h1><blockquote><p>A JavaScript library for building user interfaces</p></blockquote><p>React 是狀態和 UI 的 Library 我們都知道，使用了 React 可以這樣思考：每一個狀態都會產生出對應的 UI。使用了 React 之後，就很少使用像是 DOM 的原生 API 來操作元素了，但還是會有需要直接從 DOM 元素取得資料或者是操作的情境，這時候就是使用 ref 的時候。</p><p>React ref 就是一個可以直接操作 DOM 的出口，透過 <code>createRef</code> / <code>useRef</code>，以及將 ref 作為 props 放入 DOM element ，能透過 ref 直接操作 DOM。就像下面 React <a href="https://reactjs.org/docs/hooks-reference.html#useref">官方文件</a> 中 hooks 的範例：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">TextInputWithFocusButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> inputEl <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function function-variable">onButtonClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token comment">// `current` points to the mounted text input element</span><br>    inputEl<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>inputEl<span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"text"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>onButtonClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>Focus the input<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>我們直接透過 <code>input.current</code>，來使用 DOM 的 method。雖然上面是 Hooks 的範例，但其實在 Class component 也沒什麼不同，只是從在 function 中宣告變數變成 class 的內部屬性而已。</p><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">TextInputWithFocusButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>inutEl <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <br>	<span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br>  <br>  <span class="token function">onButtonClick</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">this</span><span class="token punctuation">.</span>inputEl<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <br>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputEl<span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"text"</span> <span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>onButtonClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>Focus the input<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>另外一個會用到的 ref 的地方是，當你希望儲存一個不會影響 ui 的狀態的時候。在 React 中，每次 state 的改變都會造成 Rerender，進而改變 UI，但並不是每次都會想要這樣。這時候就能夠把值儲存在 ref 裡面：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">notRefreshCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> counterRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>	<span class="token keyword">const</span> <span class="token function function-variable">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		counterRef<span class="token punctuation">.</span>current<span class="token operator">++</span>	<br>	<span class="token punctuation">}</span>	<br>	<br>	<span class="token keyword">const</span> <span class="token function function-variable">onPrint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>	<br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>		<span class="token operator">&lt;</span>button <span class="token parameter">onClick</span><span class="token operator">=&gt;</span>add <span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br><span class="token punctuation">}</span></code></pre><p>好的，比較基本的用法大概就是這樣了，那可以來談談一些比較有趣的用法。</p><h2 id="callback-ref"><a href="#callback-ref" class="direct-link">#</a> Callback Ref</h2><p>剛剛我們在使用 ref 的時候可以分為兩種用法</p><ol><li>透過將 ref 放入 react element（jsx 語法建立的）的 props，可以操作 element 上面的方法或者讀取屬性。</li><li>儲存不影響 UI 的值。</li></ol><p>雖然講的是 ref，但其實第一種用法我們是透過兩個東西來做到的：</p><ul><li>create Ref 的 API，不論是 <code>React.createRef</code> 還是 <code>React.useRef</code></li><li>React element 上面的 ref 屬性</li></ul><p>然而 React element 的 ref 屬性除了接受 <code>createRef</code> / <code>useRef</code> 以外，還可以接受function 的形式，	並能夠帶來更大的彈性。</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">function</span> <span class="token function">AutoSelectInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">const</span> <span class="token function function-variable">autoFocus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"App"</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>autoFocus<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></code></pre><p>上面是個應用 callback ref 的小小範例，改寫自 react 官方文件，除了 component 第一次被 render 時會 auto focus 之外。當按下 refresh 時（ <code>useState</code> 這樣的用法可以在 <a href="https://zh-hant.reactjs.org/docs/hooks-faq.html#is-there-something-like-forceupdate">React FAQ</a> 中看到），整個 component 重新 render 也會自動 focus 在 input 上面。</p><p>callback ref 是什麼？從他的名字上面就可以知道他其實是一個 callback function，那麼會在什麼時候被執行？</p><blockquote><p>React will call the <code>ref</code> callback with the DOM element when the component mounts, and call it with <code>null</code> when it unmounts. Refs are guaranteed to be up-to-date before <code>componentDidMount</code> or <code>componentDidUpdate</code> fires.</p></blockquote><p><a href="https://reactjs.org/docs/refs-and-the-dom.html#callback-refs">文件</a>中裡面提到了， callback ref 會在兩種情況被呼叫。</p><ul><li>DOM element 被 mount 上 component 的時候：執行 <code>callbackRef(element)</code></li><li>DOM element 被 unmount 的時候：執行 <code>callbackRef(null)</code></li></ul><p>在時機上，其實有點像 useEffect 的 callback 中 return 的 cleanup function，或者說是 componentDidMount 還有 componentDidUnmount 會更準確。</p><p>不過在<a href="https://reactjs.org/docs/refs-and-the-dom.html#caveats-with-callback-refs">文件</a>中有使用 callback ref 的注意事項：</p><blockquote><p>If the <code>ref</code> callback is defined as an inline function, it will get called twice during updates, first with <code>null</code> and then again with the DOM element. This is because a new instance of the function is created with each render, so React needs to clear the old ref and set up the new one. You can avoid this by defining the <code>ref</code> callback as a bound method on the class, but note that it shouldn’t matter in most cases.</p></blockquote><p>文件中提到如果使用 inline function 作為 callback ref 時，每次 rerender 都會呼叫兩次，一次是 callbackRef(null)，一次是 callbackRef(element)。原因是因為每次都會建立新的 function，所以要清理舊的 function 然後設定新的。</p><p>雖然我自己沒有很清楚為什麼清理舊的 function 就必須執行 callback。但這個原因讓我們在使用 callback ref 的時候需要注意這種情形：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">InlineAutoSelectInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> <span class="token punctuation">(</span><br>	<span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"App"</span><span class="token operator">&gt;</span><br>	  <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>	  <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>	<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br><span class="token punctuation">}</span><br></code></pre><p>如果像上面那樣是會報錯的，因為在 rerender 時第一次時 element 為 null，當然沒有 focus 給你用。</p><p>隨後有提到一種解決方法，換成 class component，然後把 方法 bind 在 class 上面，<s>但沒有人會想要再回去寫 Class component</s>。</p><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ClassComp</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>rerender <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rerender</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">rerender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <br>  <span class="token punctuation">}</span><br><br>  <span class="token function">focusRef</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  	ele<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span> <br><br>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><br>      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>        <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>focusRef<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>rerender<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>為什麼這樣就可以了呢？因為 callback ref 永遠指向同一個 function，也就是 <code>ClassComp</code> 產生的 instance 中的 <code>focusRef</code> 這個 function，而沒有建立新的，因此就不會發生 cleanup 的狀況。</p><p>但即使是這樣，React element 被 unmount 時還是會呼叫 <code>callbackRef(null)</code> ，這樣的狀況還是會找不到 <code>ele.focus</code> 而報錯。</p><p>所以比較簡單，也比較保險的方式是這樣，加個 if 就好，這樣是 null 就會自動忽略：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">InlineAutoSelectInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> <span class="token punctuation">(</span><br>	<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>	  <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">{</span><br>			element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>		  <span class="token punctuation">}</span><br>	  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>	  <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>	<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br><span class="token punctuation">}</span></code></pre><p>值得一提的是，雖然文件上只提到 inline 的 callback function 會有這個問題，但其實在 function component 中，即使使用變數也會遇到一樣的問題，我們拿前面提到的例子。</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">function</span> <span class="token function">AutoSelectInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">const</span> <span class="token function function-variable">autoFocus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>autoFocus<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></code></pre><p>因為 callback ref 一樣是在 function component 被 render 的時候才被建立的，每次被帶進去 input 時一樣是不同的 function。</p><p>那想要在 function component 中也想要做到 class component 的效果要怎麼做？既然要保持相同，最直覺的作法就是 <code>useCallback</code> 了</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">function</span> <span class="token function">AutoSelectInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">const</span> autoFocus <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>autoFocus<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></code></pre><p>除此之外，因為沒有用到 component 內部的屬性， 所以這樣處理也是可行的，把 callback ref 提到外層。提到外層後就永遠指向同一個 function 了，能夠避免在沒有 mount / unmount 也呼叫的問題。</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function function-variable">autoFocus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">AutoSelectInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>autoFocus<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>refresh<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h3 id="callback-ref-%E7%94%A8%E5%9C%A8%E5%93%AA%E8%A3%A1%EF%BC%9F"><a href="#callback-ref-%E7%94%A8%E5%9C%A8%E5%93%AA%E8%A3%A1%EF%BC%9F" class="direct-link">#</a> Callback Ref 用在哪裡？</h3><p>在剛剛的範例中，我們使用 callback ref 來讓 input 元素自動 focus，而除了這樣的用法之外，在 React 的<a href="https://reactjs.org/docs/hooks-faq.html#how-can-i-measure-a-dom-node">文件</a>中也有提到可以用來拿取 DOM element 的元素資訊。</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">MeasureExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>height<span class="token punctuation">,</span> setHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> measuredRef <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    <br>	  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <br>		  <span class="token function">setHeight</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>    <br>	  <span class="token punctuation">}</span>  <br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>h1 ref<span class="token operator">=</span><span class="token punctuation">{</span>measuredRef<span class="token punctuation">}</span><span class="token operator">&gt;</span>Hello<span class="token punctuation">,</span> world<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>      <br>	  <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>The above header is <span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">}</span>px tall<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>自己對於 callback Ref 的理解是，父層能夠用 callback Ref 的方式，能夠在 DOM element 還是 React element，設定 mount / unmount 時的 callback function。在下面的範例中：</p><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"rerender"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"effect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"layout effect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"cb1"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Hello Ref<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>input<br>        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"cb2"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">}</span><br>      <span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>div<br>        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"cb3"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">}</span><br>      <span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>click<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>PassRef<br>        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"cb4"</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">}</span><br>      <span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>ClassComp<br>        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">ins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"cb5"</span><span class="token punctuation">,</span> ins<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">}</span><br>      <span class="token operator">/</span><span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id="component-%E7%9A%84-ref"><a href="#component-%E7%9A%84-ref" class="direct-link">#</a> Component 的 ref</h2><p>剛剛提到的兩種用法是</p><ol><li>ref 綁定在 DOM element 上，可以使用<ol><li>object</li><li>callback</li></ol></li><li>ref 作為不會 rerender 的 mutable object</li></ol><p>那 ref 可以綁定在 Component Element 上嗎？可以的。</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">this</span><span class="token punctuation">.</span>addCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addCount</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><br>	<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>	<br>  <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>count<span class="token operator">:</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>			<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>counter<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>	<br>		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> ref<span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>	<span class="token keyword">const</span> <span class="token function function-variable">addConntFromParent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>Child ref<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>addConntFromParent<span class="token punctuation">}</span><span class="token operator">&gt;</span>add count<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>透過 ref，我們可以拿到 <code>ClassComp</code> 的 instance 本身，而且還可以透過 instance 來操作 <code>ClassComp</code>，換句話說，我們可以在 Parent 操作 child component 內部的狀態。</p><p>function component 也可以做到這點，但是要透過 <code>useImperativeHandle</code> 這個 API。如果用上面那個範例但是改成 function component 的話：</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">const</span>  <span class="token function function-variable">Child</span> <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>passRef<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>	<span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>passRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>		<span class="token function function-variable">addCount</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<br>	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>			<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>counter<span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>	<br>		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> ref<span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>	<span class="token keyword">const</span> <span class="token function function-variable">addCountFromParent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>Child passRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>addCountFromParent<span class="token punctuation">}</span><span class="token operator">&gt;</span>add count<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>因為 function component 本身不像 class component 一樣能夠產生 instance 儲存狀態，我在我們需要透過 useImperativeHandle，並透過第二個參數的 function 建立一個 instance 給 parent 的 ref。</p><p>從這點就可以看到，我們可以自由決定需要公開的介面給 parent，這點比起 class component 完全公開 instance 內部的 property / method 來的更加安全，也帶有一點物件導向的味道。</p><p>但是在上面的範例可以看到我們的 <code>Child</code> 接收的是 passRef 這個 props 而不是 ref。原因是如果直接使用 ref 的話在預設狀況是會如 class component 的行為一樣綁定 instance 到 ref 上面。但是 function component 和 class component 處理方式不同，在這個部分會報錯。</p><pre><code>Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?
</code></pre><p>所以上面的範例才會使用 <code>passRef</code> 而不能直接使用 ref 來傳送進去 component。因此我們會需要 React .forwardRef 讓 function component 也能夠送 ref 進去。</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">const</span> Child <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>	<span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>		<span class="token function function-variable">addCount</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<br>	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>			<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>counter<span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>	<br>		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">const</span> ref<span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<br>	<span class="token keyword">const</span> <span class="token function function-variable">addCountFromParent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br>	<br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>Child ref<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>addCountFromParent<span class="token punctuation">}</span><span class="token operator">&gt;</span>add count<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>使用了 forwardRef 這個 HOC 包住 function component 之後，就能用第二個參數來接收 ref，這樣我們可以把 ref 傳進去給 useImperativeHandle 使用了。</p><h2 id="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90" class="direct-link">#</a> 總結</h2><p>說實在這篇文章的內容幾乎都是文件上面有的東西，只是和 Ref 有關的 API 不少，再加上相關的資訊散佈再放在文件的各處，就對 Ref 比較難有全面的了解。</p><p>這篇看起來落落長，不過對於 Ref 這裡這樣理解：</p><ul><li>是建立一個 mutable 的 object<ul><li><code>React.createRef</code>：使用在 class component</li><li><code>useRef</code>：使用在 function component</li></ul></li><li>React element（包含 DOM、Function component 和 Class component）上的 ref 屬性<ul><li>可以說是 component 在 mount / unmount 的 callback<ul><li>在帶入 function時，會在 mount 時執行 <code>callbackRef(node)</code>，而在 unmount 時執行 <code>callbackRef(null)</code>。<ul><li>如果 rerender 前後是不同的 callback ref function，會進行 cleanup 執行 callback function。</li><li>DOM element 的 node 會是 element 本身</li><li>Function component 的 node 會是 useImparativeHandle 第二個參數的 return 值</li></ul></li><li>在帶入 object 時，會自動執行 <code>(ele) =&gt; {object.current = ele}</code>。</li></ul></li></ul></li></ul><h2 id="%E4%B8%80%E4%BA%9B%E5%A5%87%E6%80%AA%E7%9A%84%E7%99%BC%E7%8F%BE%E5%92%8C%E7%8C%9C%E6%83%B3"><a href="#%E4%B8%80%E4%BA%9B%E5%A5%87%E6%80%AA%E7%9A%84%E7%99%BC%E7%8F%BE%E5%92%8C%E7%8C%9C%E6%83%B3" class="direct-link">#</a> 一些奇怪的發現和猜想</h2><p>在研究 ref 的時候做了些實驗，不過以目前對 react 的理解也還沒辦法解釋，或者有些東西目前只能做猜想沒辦法做證實（要證實只能看 source code 了，但目前看不太懂），所以就放在這邊，如果讀者們能夠解釋或者有想法的話歡迎提點或者是討論。</p><h3 id="%E9%97%9C%E6%96%BC-callback-ref-%E5%92%8C-component-%E6%9C%AC%E8%BA%AB-lifecycle-%E7%9A%84%E9%A0%86%E5%BA%8F"><a href="#%E9%97%9C%E6%96%BC-callback-ref-%E5%92%8C-component-%E6%9C%AC%E8%BA%AB-lifecycle-%E7%9A%84%E9%A0%86%E5%BA%8F" class="direct-link">#</a> 關於 callback ref 和 component 本身 lifecycle 的順序</h3><p>我們把 給予 ref 的 Component 稱作 Parent，而接受 ref 的稱作 Child。</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>	<span class="token keyword">return</span> <span class="token punctuation">(</span><br>		<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>			<span class="token operator">&lt;</span>FuncChild<span class="token operator">/</span><span class="token operator">&gt;</span><br>			<span class="token operator">&lt;</span>ClassChild<span class="token operator">/</span><span class="token operator">&gt;</span><br>		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>	<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br></code></pre><p>我們都知道不管是 function component 還是 class component 本身都有所謂的 lifecycle / effect，會在 component 本身 render 結束之後被執行。自己蠻好奇說這些 lifecycle 和 callback ref 之間的執行順序是怎麼樣的，所以寫了下面這個實驗：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span>  FuncChild <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">fowardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"func effect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>	<span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"func layoutEffect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>	<span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'func useImperativeHandle'</span><span class="token punctuation">)</span><br>		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"name"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>FuncComp<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">ClassChild</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"class componentDidMount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>ClassComp<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"div ref"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>ClassChild<br>        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"class ref"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">}</span><br>      <span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>FuncChild<br>        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"func ref"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">}</span><br>      <span class="token operator">/</span><span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><pre><code>class componentDidMount
class ref
func layout effect
func useImpaertive
func ref
div ref
func effect
</code></pre><p>首先比較可以理解的是各個 element 的 ref 被 print 出來的順序：</p><ol><li>class component</li><li>function comonent</li><li>div</li></ol><p>class component 在 function component 前，所以這個順序理所當然。而因為 div 在外層，所以會等 children 被 render 完之後才會被 mount 上去，在最後很合理。</p><p>再來是 class component 的 ref 和 lifecycle 的順序。對於 class component 太不熟了，而且也蠻懶得去找資料，但可以理解的是會先執行完 component 內部的 lifecycle，然後才被 mount 上去 Parent component，所以才會是這樣的執行順序。</p><p>最後是 function component。第一點是 useLayoutEffect 的執行會在 ref 前面，layoutEffect 會在 DOM paint 後執行，這個部分覺得蠻合理的，而且文件也有提到 useLayoutEffect 觸發的時間點和 componentDidMount 相同。</p><p>最疑惑的是這點，useEffect 的觸發點在 callback ref 後面是可以預期的，會在 paint 之後。但這個結果代表說不只是在 component paint 之後，而是在整個 app 被重新 paint 之後（在 div ref 後面）。</p><p>這個研究大概就到這邊了，關於 useEffect 的執行時機點，Child / Parent 被 render 還有 paint 的順序，甚至還有 hook 是在什麼時間被執行的，這些概念目前似乎都很模糊，還需要更多理解。</p><h3 id="%E7%B4%94%E6%89%8B%E5%B7%A5-ref"><a href="#%E7%B4%94%E6%89%8B%E5%B7%A5-ref" class="direct-link">#</a> 純手工 ref</h3><p>我們真的需要 createRef / useRef？</p><pre class="language-js"><code class="language-js"><br><span class="token keyword">class</span> <span class="token class-name">ClassComp</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token punctuation">{</span><br>      current<span class="token operator">:</span> <span class="token keyword">null</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> show<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>printRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printRef</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>toggle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">printRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">toggle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> show <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> show<span class="token operator">:</span> <span class="token operator">!</span>show <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><br>      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>        <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>show <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>h1 ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>ref<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token number">123</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">}</span><br>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>printRef<span class="token punctuation">}</span><span class="token operator">&gt;</span>print<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>toggle<span class="token punctuation">}</span><span class="token operator">&gt;</span>toggle<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token punctuation">{</span><br>  current<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">FuncComp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>show<span class="token punctuation">,</span> setShow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function function-variable">toggle</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">setShow</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">}</span><br>  <span class="token keyword">const</span> <span class="token function function-variable">printRef</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token punctuation">{</span>show <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>h1 ref<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">&gt;</span>h1<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">}</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>printRef<span class="token punctuation">}</span><span class="token operator">&gt;</span>print ref<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>toggle<span class="token punctuation">}</span><span class="token operator">&gt;</span>toggle<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>這兩個範例都是沒問題的，不論是在 <code>h1</code> 有沒有 show 的狀態都可以正常的表現 ref 為 element / null。那為什麼會需要這兩個 api？useRef 或者是 React.createRef 是不是有做一些其他的事情？可能需要再研究了。</p><h3 id="%E4%B8%8D%E4%BD%BF%E7%94%A8-useinperativehandle-%E4%BE%86%E5%81%9A%E7%B6%81%E5%AE%9A%E7%9A%84%E8%A9%B1%E6%9C%83%E6%80%8E%E9%BA%BC%E6%A8%A3%EF%BC%9F"><a href="#%E4%B8%8D%E4%BD%BF%E7%94%A8-useinperativehandle-%E4%BE%86%E5%81%9A%E7%B6%81%E5%AE%9A%E7%9A%84%E8%A9%B1%E6%9C%83%E6%80%8E%E9%BA%BC%E6%A8%A3%EF%BC%9F" class="direct-link">#</a> 不使用 useInperativeHandle 來做綁定的話會怎麼樣？</h3><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Child <span class="token operator">=</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><br>  <span class="token keyword">const</span> <span class="token function function-variable">toggle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>state<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br>  ref<span class="token punctuation">.</span>current <span class="token operator">=</span> toggle<span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"func"</span><span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span>state <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">Parent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> refresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token function function-variable">click</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token punctuation">)</span> <span class="token punctuation">{</span> ref<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>Child ref<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>refresh<span class="token punctuation">}</span><span class="token operator">&gt;</span>rerender<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>click<span class="token punctuation">}</span><span class="token operator">&gt;</span>toggle<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><s>到底是為什麼要一直不照文件的做</s>。用上面的作法，完全不使用 useImperativeHandle 這個 api，自己把 component 內的 setState 綁定到 <code>ref.current</code> 上面，這樣的用法也是沒問題的，不過也不清楚原因就是了。</p><h2 id="%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><a href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99" class="direct-link">#</a> 參考資料</h2><p>其實也不過都是文件而已</p><ul><li><a href="https://reactjs.org/docs/hooks-reference.html">Hooks API Reference</a></li><li><a href="https://reactjs.org/docs/hooks-faq.html#how-can-i-measure-a-dom-node">How can I measure a DOM node?</a></li><li><a href="https://reactjs.org/docs/react-api.html#reactforwardref">React.fowardRef</a></li><li><a href="https://reactjs.org/docs/refs-and-the-dom.html">Refs and the DOM</a></li><li><a href="https://reactjs.org/docs/forwarding-refs.html">Forwarding Refs</a></li></ul></article><div class="post__tags tags"><h2>tags</h2><a href="/tags/react/">react</a></div><div class="post__link"><div></div><div></div></div><hr class="post__devider"><div class="utterances"></div><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" issue-term="title" label="utterance" repo="Lauviah0622/Lavi-blog" theme="github-light"></script><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "React Ref 的一點研究",
  "image": [],
  "author": "Lavi", 
  "genre": "Insert a schema.org genre", 
  "publisher": {
    "@type": "Organization",
    "name": "Lavi",
    "logo": {
      "@type": "ImageObject",
      "url": "/img/favicon/favicon-192x192.png?hash=2089033c93"
    }
  },
  "url": "https://lavi-blog.vercel.app/posts/react-ref-reference/",
  "mainEntityOfPage": "https://lavi-blog.vercel.app/posts/react-ref-reference/",
  "datePublished": "2021-09-27",
  "dateModified": "2021-10-17",
  "description": "# React Ref 的一點研究 A JavaScript library for building user interfaces React 是狀態和 UI 的 Library 我們都知道，使用了 React 可以這樣思考：每一個狀態都會產生出對應的 UI。使用了..."
}</script><script csp-hash="sha256-S74q1WGEGfQZyLlS1Dzl4+dKEQ+b0Z0yGiPJt7XNB5k=">let prevElement;
 const io = new IntersectionObserver(
  (entries) => {
    entries.forEach((entry) => {
      const id = entry.target.id
        if (id === "title") {
          const title = document.querySelector(`#${id}`)
          if (prevElement) {
            prevElement.classList.remove('current');
          }
          return  
        }
        const current = document.querySelector(`[data-header="${id}"]`);
        if (current == null) return 
        if (entry.isIntersecting) {
          current.classList.add('current');
          if (prevElement && prevElement != current) {
            prevElement.classList.remove('current');
          }
          prevElement = current
        }
        
    });
  },
  {
    rootMargin: "-10% 0% -70% 0%",
  }
);

// Declares what to observe, and observes its properties.
const boxElList = document.querySelectorAll('h1, h2, h3, h4');
boxElList.forEach((el) => {
    io.observe(el);
})</script></main><footer class="center center--wide"><div class="footer"><div><nav class="nav"><h1 class="logo"><a href="/" title="Homepage"><svg fill="none" viewBox="0 0 39 33" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M19.5 0L38.1195 32.25H0.880453L19.5 0Z" fill="#90A0A8"></path></svg> Apprentice Log</a></h1><a href="/tags/">Tags</a> <a href="/about/">About</a></nav></div><div class="caption footer__info"><div><a href="https://github.com/Lauviah0622" target="_blank"><svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M12.026 2C7.13295 1.99937 2.96183 5.54799 2.17842 10.3779C1.395 15.2079 4.23061 19.893 8.87302 21.439C9.37302 21.529 9.55202 21.222 9.55202 20.958C9.55202 20.721 9.54402 20.093 9.54102 19.258C6.76602 19.858 6.18002 17.92 6.18002 17.92C5.99733 17.317 5.60459 16.7993 5.07302 16.461C4.17302 15.842 5.14202 15.856 5.14202 15.856C5.78269 15.9438 6.34657 16.3235 6.66902 16.884C6.94195 17.3803 7.40177 17.747 7.94632 17.9026C8.49087 18.0583 9.07503 17.99 9.56902 17.713C9.61544 17.207 9.84055 16.7341 10.204 16.379C7.99002 16.128 5.66202 15.272 5.66202 11.449C5.64973 10.4602 6.01691 9.5043 6.68802 8.778C6.38437 7.91731 6.42013 6.97325 6.78802 6.138C6.78802 6.138 7.62502 5.869 9.53002 7.159C11.1639 6.71101 12.8882 6.71101 14.522 7.159C16.428 5.868 17.264 6.138 17.264 6.138C17.6336 6.97286 17.6694 7.91757 17.364 8.778C18.0376 9.50423 18.4045 10.4626 18.388 11.453C18.388 15.286 16.058 16.128 13.836 16.375C14.3153 16.8651 14.5612 17.5373 14.511 18.221C14.511 19.555 14.499 20.631 14.499 20.958C14.499 21.225 14.677 21.535 15.186 21.437C19.8265 19.8884 22.6591 15.203 21.874 10.3743C21.089 5.54565 16.9181 1.99888 12.026 2Z" fill="#2E3A59"></path></svg></a></div><p>© 2020-present Lavi. All Rights Reserved.<br>This website based on <a href="https://www.industrialempathy.com/posts/eleventy-high-performance-blog/">eleventy-high-performance-blog</a>.</p></div></div></footer></div><script csp-hash="sha256-AvHvdkAvA2liH7FoblyZGebwmSzE3eLp/zZiYQ+l2Qk=">const dark = document.querySelector('#dark');
      const light = document.querySelector('#light');
      dark.addEventListener('click', () => {
        document.body.classList.add('dark-theme')
        localStorage.setItem("theme", 'dark')
        setUtterancesTheme('dark');
      })
      light.addEventListener('click', () => {
        document.body.classList.remove('dark-theme')
        localStorage.setItem("theme", 'light')
        setUtterancesTheme('light');
      })
      const ham = document.querySelector('#hamburger');
      ham.addEventListener('click', () => {
        document.querySelector('header').classList.toggle('open')
        ham.classList.toggle('open');
      })</script></body></html>